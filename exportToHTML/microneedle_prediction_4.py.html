<html>
<head>
<title>microneedle_prediction_4.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #65737e;}
.s1 { color: #c0c5ce;}
.s2 { color: #b48ead;}
.s3 { color: #8fa1b3;}
.s4 { color: #a3be8c;}
.s5 { color: #a3be8c; font-style: italic;}
.s6 { color: #ab7967;}
.s7 { color: #d0876e;}
</style>
</head>
<body bgcolor="#2b303b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
microneedle_prediction_4.py</font>
</center></td></tr></table>
<pre><span class="s0"># 基础库</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">torch</span>
<span class="s2">import </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">nn </span><span class="s2">as </span><span class="s1">nn</span>
<span class="s2">import </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">optim </span><span class="s2">as </span><span class="s1">optim</span>
<span class="s2">from </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">data </span><span class="s2">import </span><span class="s1">TensorDataset</span><span class="s3">, </span><span class="s1">DataLoader</span>
<span class="s2">import </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">.</span><span class="s1">cudnn</span>
<span class="s2">import </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">.</span><span class="s1">mkldnn  </span><span class="s0"># 替换原来的 torch.utils.mkl</span>

<span class="s0"># 系统和工具库</span>
<span class="s2">import </span><span class="s1">json</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">platform</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">multiprocessing</span>
<span class="s2">from </span><span class="s1">datetime </span><span class="s2">import </span><span class="s1">datetime</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Dict</span><span class="s3">, </span><span class="s1">List</span><span class="s3">, </span><span class="s1">Tuple</span>
<span class="s2">from </span><span class="s1">enum </span><span class="s2">import </span><span class="s1">Enum</span>

<span class="s0"># 禁用警告</span>
<span class="s1">warnings</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s4">'ignore'</span><span class="s3">)</span>

<span class="s0"># 配置日志</span>
<span class="s1">logging</span><span class="s3">.</span><span class="s1">basicConfig</span><span class="s3">(</span>
    <span class="s1">level</span><span class="s3">=</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">,</span>
    <span class="s1">format</span><span class="s3">=</span><span class="s4">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="s3">,</span>
    <span class="s1">handlers</span><span class="s3">=[</span>
        <span class="s1">logging</span><span class="s3">.</span><span class="s1">FileHandler</span><span class="s3">(</span><span class="s4">'microneedle_quality.log'</span><span class="s3">),</span>
        <span class="s1">logging</span><span class="s3">.</span><span class="s1">StreamHandler</span><span class="s3">()</span>
    <span class="s3">]</span>
<span class="s3">)</span>
<span class="s1">logger </span><span class="s3">= </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">getLogger</span><span class="s3">(</span><span class="s1">__name__</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_dependencies</span><span class="s3">():</span>
    <span class="s5">&quot;&quot;&quot;检查必要的依赖是否已安装&quot;&quot;&quot;</span>
    <span class="s1">required_packages </span><span class="s3">= {</span>
        <span class="s4">'numpy'</span><span class="s3">: </span><span class="s4">'numpy'</span><span class="s3">,</span>
        <span class="s4">'torch'</span><span class="s3">: </span><span class="s4">'torch'</span><span class="s3">,</span>
        <span class="s4">'platform'</span><span class="s3">: </span><span class="s4">'platform'</span><span class="s3">,</span>
        <span class="s4">'multiprocessing'</span><span class="s3">: </span><span class="s4">'multiprocessing'</span>
    <span class="s3">}</span>

    <span class="s1">missing_packages </span><span class="s3">= []</span>
    <span class="s1">version_info </span><span class="s3">= {}</span>

    <span class="s2">for </span><span class="s1">package</span><span class="s3">, </span><span class="s1">import_name </span><span class="s2">in </span><span class="s1">required_packages</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">module </span><span class="s3">= </span><span class="s1">__import__</span><span class="s3">(</span><span class="s1">import_name</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">module</span><span class="s3">, </span><span class="s4">'__version__'</span><span class="s3">):</span>
                <span class="s1">version_info</span><span class="s3">[</span><span class="s1">package</span><span class="s3">] = </span><span class="s1">module</span><span class="s3">.</span><span class="s1">__version__</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">version_info</span><span class="s3">[</span><span class="s1">package</span><span class="s3">] = </span><span class="s4">&quot;版本未知&quot;</span>
        <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
            <span class="s1">missing_packages</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">package</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">missing_packages</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;错误: 以下必要的包未安装:&quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">package </span><span class="s2">in </span><span class="s1">missing_packages</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;  - </span><span class="s6">{</span><span class="s1">package</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请使用pip安装这些包:&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;pip install </span><span class="s6">{</span><span class="s4">' '</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">missing_packages</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">sys</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s7">1</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;所有依赖检查通过&quot;</span><span class="s3">)</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;包版本信息:&quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">package</span><span class="s3">, </span><span class="s1">version </span><span class="s2">in </span><span class="s1">version_info</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;  </span><span class="s6">{</span><span class="s1">package</span><span class="s6">}</span><span class="s4">: </span><span class="s6">{</span><span class="s1">version</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_cuda_availability</span><span class="s3">():</span>
    <span class="s5">&quot;&quot;&quot;检查CUDA是否可用并打印设备信息&quot;&quot;&quot;</span>
    <span class="s1">device </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">():</span>
            <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cuda&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">CUDA可用！使用设备: </span><span class="s6">{</span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">get_device_name</span><span class="s3">(</span><span class="s7">0</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

            <span class="s0"># 显示显存信息</span>
            <span class="s1">total_memory </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">get_device_properties</span><span class="s3">(</span><span class="s7">0</span><span class="s3">).</span><span class="s1">total_memory </span><span class="s3">/ </span><span class="s7">1024 </span><span class="s3">** </span><span class="s7">3</span>
            <span class="s1">allocated_memory </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">memory_allocated</span><span class="s3">(</span><span class="s7">0</span><span class="s3">) / </span><span class="s7">1024 </span><span class="s3">** </span><span class="s7">3</span>
            <span class="s1">cached_memory </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">memory_reserved</span><span class="s3">(</span><span class="s7">0</span><span class="s3">) / </span><span class="s7">1024 </span><span class="s3">** </span><span class="s7">3</span>

            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;总显存: </span><span class="s6">{</span><span class="s1">total_memory</span><span class="s6">:</span><span class="s4">.1f</span><span class="s6">} </span><span class="s4">GB&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;已分配显存: </span><span class="s6">{</span><span class="s1">allocated_memory</span><span class="s6">:</span><span class="s4">.1f</span><span class="s6">} </span><span class="s4">GB&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;缓存显存: </span><span class="s6">{</span><span class="s1">cached_memory</span><span class="s6">:</span><span class="s4">.1f</span><span class="s6">} </span><span class="s4">GB&quot;</span><span class="s3">)</span>

            <span class="s0"># 检查CUDA版本</span>
            <span class="s1">cuda_version </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">version</span><span class="s3">.</span><span class="s1">cuda</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;CUDA版本: </span><span class="s6">{</span><span class="s1">cuda_version</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

            <span class="s0"># 检查cuDNN版本</span>
            <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">, </span><span class="s4">'cudnn'</span><span class="s3">):</span>
                <span class="s1">cudnn_version </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">.</span><span class="s1">cudnn</span><span class="s3">.</span><span class="s1">version</span><span class="s3">()</span>
                <span class="s1">cudnn_enabled </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">.</span><span class="s1">cudnn</span><span class="s3">.</span><span class="s1">enabled</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;cuDNN版本: </span><span class="s6">{</span><span class="s1">cudnn_version</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;cuDNN启用状态: </span><span class="s6">{</span><span class="s4">'是' </span><span class="s2">if </span><span class="s1">cudnn_enabled </span><span class="s2">else </span><span class="s4">'否'</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

            <span class="s0"># 设置GPU性能优化</span>
            <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">, </span><span class="s4">'cudnn'</span><span class="s3">):</span>
                <span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">.</span><span class="s1">cudnn</span><span class="s3">.</span><span class="s1">benchmark </span><span class="s3">= </span><span class="s2">True</span>
                <span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">.</span><span class="s1">cudnn</span><span class="s3">.</span><span class="s1">deterministic </span><span class="s3">= </span><span class="s2">False</span>
                <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;已启用CUDA性能优化&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">CUDA不可用，使用CPU进行计算&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;警告：使用CPU训练可能会显著降低运行速度&quot;</span><span class="s3">)</span>

            <span class="s0"># 显示CPU信息</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;CPU型号: </span><span class="s6">{</span><span class="s1">platform</span><span class="s3">.</span><span class="s1">processor</span><span class="s3">()</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;CPU核心数: </span><span class="s6">{</span><span class="s1">multiprocessing</span><span class="s3">.</span><span class="s1">cpu_count</span><span class="s3">()</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

            <span class="s0"># 检查CPU优化状态</span>
            <span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">.</span><span class="s1">mkldnn</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">():</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;MKL-DNN加速: 可用&quot;</span><span class="s3">)</span>
                <span class="s1">torch</span><span class="s3">.</span><span class="s1">backends</span><span class="s3">.</span><span class="s1">mkldnn</span><span class="s3">.</span><span class="s1">enabled </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;MKL-DNN加速: 不可用&quot;</span><span class="s3">)</span>

            <span class="s0"># 设置线程数</span>
            <span class="s1">torch</span><span class="s3">.</span><span class="s1">set_num_threads</span><span class="s3">(</span><span class="s1">multiprocessing</span><span class="s3">.</span><span class="s1">cpu_count</span><span class="s3">())</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;已设置CPU线程数: </span><span class="s6">{</span><span class="s1">multiprocessing</span><span class="s3">.</span><span class="s1">cpu_count</span><span class="s3">()</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;检查设备状态时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">检查设备状态时出错，将使用CPU进行计算&quot;</span><span class="s3">)</span>

    <span class="s0"># 记录设备信息</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;使用计算设备: </span><span class="s6">{</span><span class="s1">device</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">device</span>


<span class="s0"># 在程序开始时运行依赖检查</span>
<span class="s1">check_dependencies</span><span class="s3">()</span>


<span class="s0"># 定义打印方式枚举</span>
<span class="s2">class </span><span class="s1">PrintMode</span><span class="s3">(</span><span class="s1">Enum</span><span class="s3">):</span>
    <span class="s1">CONTINUOUS </span><span class="s3">= </span><span class="s7">0  </span><span class="s0"># 连续打印</span>
    <span class="s1">INTERMITTENT </span><span class="s3">= </span><span class="s7">1  </span><span class="s0"># 间歇打印</span>
    <span class="s1">RECIPROCATING </span><span class="s3">= </span><span class="s7">2  </span><span class="s0"># 往复打印</span>


<span class="s0"># 定义输入特征和质量评分组件</span>
<span class="s1">input_features </span><span class="s3">= [</span>
    <span class="s4">'layer_height'</span><span class="s3">,  </span><span class="s0"># 打印层高</span>
    <span class="s4">'exposure_time'</span><span class="s3">,  </span><span class="s0"># 曝光时间</span>
    <span class="s4">'exposure_intensity'</span><span class="s3">,  </span><span class="s0"># 曝光强度</span>
    <span class="s4">'bottom_layers'</span><span class="s3">,  </span><span class="s0"># 底层层数</span>
    <span class="s4">'bottom_exposure_intensity'</span><span class="s3">,  </span><span class="s0"># 底曝亮度</span>
    <span class="s4">'lifting_speed'</span><span class="s3">,  </span><span class="s0"># 抬升速度</span>
    <span class="s4">'exposure_wait'</span><span class="s3">,  </span><span class="s0"># 曝光前等待</span>
    <span class="s4">'liquid_speed'</span><span class="s3">,  </span><span class="s0"># 入液速度</span>
    <span class="s4">'bottom_exposure_time'</span><span class="s3">,  </span><span class="s0"># 底部曝光时间</span>
    <span class="s4">'print_mode'  </span><span class="s0"># 打印方式</span>
<span class="s3">]</span>

<span class="s1">quality_score_components </span><span class="s3">= [</span>
    <span class="s4">'needle_definition'</span><span class="s3">,  </span><span class="s0"># 针尖清晰度</span>
    <span class="s4">'layer_adhesion'</span><span class="s3">,  </span><span class="s0"># 层间粘结性</span>
    <span class="s4">'needle_height'</span><span class="s3">,  </span><span class="s0"># 针尖高度</span>
    <span class="s4">'base_thickness'</span><span class="s3">,  </span><span class="s0"># 底座厚度</span>
    <span class="s4">'material_curing'  </span><span class="s0"># 材料固化度</span>
<span class="s3">]</span>

<span class="s1">quality_score_weights </span><span class="s3">= {</span>
    <span class="s4">'needle_definition'</span><span class="s3">: </span><span class="s7">0.3</span><span class="s3">,</span>
    <span class="s4">'layer_adhesion'</span><span class="s3">: </span><span class="s7">0.2</span><span class="s3">,</span>
    <span class="s4">'needle_height'</span><span class="s3">: </span><span class="s7">0.2</span><span class="s3">,</span>
    <span class="s4">'base_thickness'</span><span class="s3">: </span><span class="s7">0.15</span><span class="s3">,</span>
    <span class="s4">'material_curing'</span><span class="s3">: </span><span class="s7">0.15</span>
<span class="s3">}</span>

<span class="s0"># 定义参数的合理范围</span>
<span class="s1">PARAM_RANGES </span><span class="s3">= {</span>
    <span class="s4">'layer_height'</span><span class="s3">: (</span><span class="s7">0.01</span><span class="s3">, </span><span class="s7">0.1</span><span class="s3">, </span><span class="s7">0.01</span><span class="s3">),  </span><span class="s0"># 范围：0.01-0.1mm，步长0.01</span>
    <span class="s4">'exposure_time'</span><span class="s3">: (</span><span class="s7">1.0</span><span class="s3">, </span><span class="s7">10.0</span><span class="s3">, </span><span class="s7">0.5</span><span class="s3">),  </span><span class="s0"># 范围：1-10秒，步长0.5</span>
    <span class="s4">'exposure_intensity'</span><span class="s3">: (</span><span class="s7">50</span><span class="s3">, </span><span class="s7">100</span><span class="s3">, </span><span class="s7">5</span><span class="s3">),  </span><span class="s0"># 范围：50-100%，步长5</span>
    <span class="s4">'bottom_layers'</span><span class="s3">: (</span><span class="s7">3</span><span class="s3">, </span><span class="s7">8</span><span class="s3">, </span><span class="s7">1</span><span class="s3">),  </span><span class="s0"># 范围：3-8层，步长1</span>
    <span class="s4">'bottom_exposure_intensity'</span><span class="s3">: (</span><span class="s7">60</span><span class="s3">, </span><span class="s7">100</span><span class="s3">, </span><span class="s7">5</span><span class="s3">),  </span><span class="s0"># 范围：60-100%，步长5</span>
    <span class="s4">'lifting_speed'</span><span class="s3">: (</span><span class="s7">0.5</span><span class="s3">, </span><span class="s7">3.0</span><span class="s3">, </span><span class="s7">0.5</span><span class="s3">),  </span><span class="s0"># 范围：0.5-3.0mm/s，步长0.5</span>
    <span class="s4">'exposure_wait'</span><span class="s3">: (</span><span class="s7">0.1</span><span class="s3">, </span><span class="s7">2.0</span><span class="s3">, </span><span class="s7">0.1</span><span class="s3">),  </span><span class="s0"># 范围：0.1-2.0秒，步长0.1</span>
    <span class="s4">'liquid_speed'</span><span class="s3">: (</span><span class="s7">0.5</span><span class="s3">, </span><span class="s7">3.0</span><span class="s3">, </span><span class="s7">0.5</span><span class="s3">),  </span><span class="s0"># 范围：0.5-3.0mm/s，步长0.5</span>
    <span class="s4">'bottom_exposure_time'</span><span class="s3">: (</span><span class="s7">10</span><span class="s3">, </span><span class="s7">30</span><span class="s3">, </span><span class="s7">2</span><span class="s3">),  </span><span class="s0"># 范围：10-30秒，步长2</span>
    <span class="s4">'print_mode'</span><span class="s3">: (</span><span class="s7">0</span><span class="s3">, </span><span class="s7">2</span><span class="s3">, </span><span class="s7">1</span><span class="s3">)  </span><span class="s0"># 打印方式：0-连续，1-间歇，2-往复</span>
<span class="s3">}</span>


<span class="s2">def </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s1">prompt</span><span class="s3">, </span><span class="s1">default</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;安全处理用户输入，包含中断处理&quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">input</span><span class="s3">(</span><span class="s1">prompt</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s3">(</span><span class="s1">KeyboardInterrupt</span><span class="s3">, </span><span class="s1">EOFError</span><span class="s3">):</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">输入被中断。&quot; </span><span class="s3">+ (</span><span class="s4">&quot;使用默认值。&quot; </span><span class="s2">if </span><span class="s1">default </span><span class="s2">else </span><span class="s4">&quot;退出程序。&quot;</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">default </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">default</span>
        <span class="s1">sys</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s7">0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">get_parameter_unit</span><span class="s3">(</span><span class="s1">param</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;获取参数的单位&quot;&quot;&quot;</span>
    <span class="s1">units </span><span class="s3">= {</span>
        <span class="s4">'layer_height'</span><span class="s3">: </span><span class="s4">'mm'</span><span class="s3">,</span>
        <span class="s4">'exposure_time'</span><span class="s3">: </span><span class="s4">'秒'</span><span class="s3">,</span>
        <span class="s4">'exposure_intensity'</span><span class="s3">: </span><span class="s4">'%'</span><span class="s3">,</span>
        <span class="s4">'bottom_layers'</span><span class="s3">: </span><span class="s4">'层'</span><span class="s3">,</span>
        <span class="s4">'bottom_exposure_intensity'</span><span class="s3">: </span><span class="s4">'%'</span><span class="s3">,</span>
        <span class="s4">'lifting_speed'</span><span class="s3">: </span><span class="s4">'mm/s'</span><span class="s3">,</span>
        <span class="s4">'exposure_wait'</span><span class="s3">: </span><span class="s4">'秒'</span><span class="s3">,</span>
        <span class="s4">'liquid_speed'</span><span class="s3">: </span><span class="s4">'mm/s'</span><span class="s3">,</span>
        <span class="s4">'bottom_exposure_time'</span><span class="s3">: </span><span class="s4">'秒'</span><span class="s3">,</span>
        <span class="s4">'print_mode'</span><span class="s3">: </span><span class="s4">''</span>
    <span class="s3">}</span>
    <span class="s2">return </span><span class="s1">units</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">param</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">get_print_mode_name</span><span class="s3">(</span><span class="s1">mode_value</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;获取打印方式的名称&quot;&quot;&quot;</span>
    <span class="s1">mode_names </span><span class="s3">= {</span>
        <span class="s7">0</span><span class="s3">: </span><span class="s4">&quot;连续打印&quot;</span><span class="s3">,</span>
        <span class="s7">1</span><span class="s3">: </span><span class="s4">&quot;间歇打印&quot;</span><span class="s3">,</span>
        <span class="s7">2</span><span class="s3">: </span><span class="s4">&quot;往复打印&quot;</span>
    <span class="s3">}</span>
    <span class="s2">return </span><span class="s1">mode_names</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">mode_value</span><span class="s3">, </span><span class="s4">&quot;未知&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">input_params</span><span class="s3">():</span>
    <span class="s5">&quot;&quot;&quot;获取用户输入的参数值&quot;&quot;&quot;</span>
    <span class="s1">params </span><span class="s3">= {}</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请输入以下参数：&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">参数说明：&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- layer_height: 打印层高，影响打印精度和时间&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- exposure_time: 光固化时间，影响材料固化程度&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- exposure_intensity: 光照强度，影响固化效果&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- bottom_layers: 底层数量，影响基底牢固程度&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- bottom_exposure_intensity: 底层曝光强度&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- lifting_speed: 构建平台抬升速度&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- exposure_wait: 曝光前等待时间，用于材料稳定&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- liquid_speed: 料槽进料速度&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- bottom_exposure_time: 底层曝光时间&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- print_mode: 打印模式(0-连续，1-间歇，2-往复)&quot;</span><span class="s3">)</span>

    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">feature </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">:</span>
            <span class="s2">while True</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">feature </span><span class="s3">== </span><span class="s4">'print_mode'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">打印方式选项：&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;0 - 连续打印: 打印速度快，适合简单结构&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;1 - 间歇打印: 层间结合好，打印时间长&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;2 - 往复打印: 可能影响表面质量，需要调整速度&quot;</span><span class="s3">)</span>
                        <span class="s1">value_str </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">feature</span><span class="s6">} </span><span class="s4">[0-2]: &quot;</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">step </span><span class="s3">= </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">feature</span><span class="s3">]</span>
                        <span class="s1">unit </span><span class="s3">= </span><span class="s1">get_parameter_unit</span><span class="s3">(</span><span class="s1">feature</span><span class="s3">)</span>
                        <span class="s1">value_str </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">feature</span><span class="s6">} </span><span class="s4">[</span><span class="s6">{</span><span class="s1">min_val</span><span class="s6">}</span><span class="s4">-</span><span class="s6">{</span><span class="s1">max_val</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">]: &quot;</span><span class="s3">)</span>

                    <span class="s1">value </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">value_str</span><span class="s3">)</span>

                    <span class="s0"># 验证参数范围</span>
                    <span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">feature</span><span class="s3">]</span>
                    <span class="s2">if not </span><span class="s1">min_val </span><span class="s3">&lt;= </span><span class="s1">value </span><span class="s3">&lt;= </span><span class="s1">max_val</span><span class="s3">:</span>
                        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;输入值超出范围 (</span><span class="s6">{</span><span class="s1">min_val</span><span class="s6">}</span><span class="s4">-</span><span class="s6">{</span><span class="s1">max_val</span><span class="s6">}</span><span class="s4">)&quot;</span><span class="s3">)</span>

                    <span class="s1">params</span><span class="s3">[</span><span class="s1">feature</span><span class="s3">] = </span><span class="s1">value</span>
                    <span class="s2">break</span>
                <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;请重新输入</span><span class="s6">\n</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">params</span>

    <span class="s2">except </span><span class="s1">KeyboardInterrupt</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;参数输入被用户中断&quot;</span><span class="s3">)</span>
        <span class="s2">raise</span>
    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;参数输入过程出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">raise</span>


<span class="s2">class </span><span class="s1">MicroneedleQualityModel</span><span class="s3">(</span><span class="s1">nn</span><span class="s3">.</span><span class="s1">Module</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;微针质量预测模型&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">num_inputs</span><span class="s3">, </span><span class="s1">num_outputs</span><span class="s3">, </span><span class="s1">layer_sizes</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">layers </span><span class="s3">= </span><span class="s1">nn</span><span class="s3">.</span><span class="s1">ModuleList</span><span class="s3">()</span>

        <span class="s0"># 输入层</span>
        <span class="s1">prev_size </span><span class="s3">= </span><span class="s1">num_inputs</span>
        <span class="s2">for </span><span class="s1">size </span><span class="s2">in </span><span class="s1">layer_sizes</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">layers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">nn</span><span class="s3">.</span><span class="s1">Linear</span><span class="s3">(</span><span class="s1">prev_size</span><span class="s3">, </span><span class="s1">size</span><span class="s3">))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">layers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">nn</span><span class="s3">.</span><span class="s1">ReLU</span><span class="s3">())</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">layers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">nn</span><span class="s3">.</span><span class="s1">BatchNorm1d</span><span class="s3">(</span><span class="s1">size</span><span class="s3">))  </span><span class="s0"># 添加批归一化</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">layers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">nn</span><span class="s3">.</span><span class="s1">Dropout</span><span class="s3">(</span><span class="s7">0.2</span><span class="s3">))  </span><span class="s0"># 添加dropout</span>
            <span class="s1">prev_size </span><span class="s3">= </span><span class="s1">size</span>

        <span class="s0"># 输出层</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">layers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">nn</span><span class="s3">.</span><span class="s1">Linear</span><span class="s3">(</span><span class="s1">prev_size</span><span class="s3">, </span><span class="s1">num_outputs</span><span class="s3">))</span>

        <span class="s0"># 参数初始化</span>
        <span class="s2">for </span><span class="s1">layer </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">layers</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">layer</span><span class="s3">, </span><span class="s1">nn</span><span class="s3">.</span><span class="s1">Linear</span><span class="s3">):</span>
                <span class="s1">nn</span><span class="s3">.</span><span class="s1">init</span><span class="s3">.</span><span class="s1">xavier_uniform_</span><span class="s3">(</span><span class="s1">layer</span><span class="s3">.</span><span class="s1">weight</span><span class="s3">)</span>
                <span class="s1">nn</span><span class="s3">.</span><span class="s1">init</span><span class="s3">.</span><span class="s1">zeros_</span><span class="s3">(</span><span class="s1">layer</span><span class="s3">.</span><span class="s1">bias</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">forward</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">layer </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">layers</span><span class="s3">:</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">layer</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">x</span>


<span class="s2">def </span><span class="s1">generate_synthetic_data</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s7">1000</span><span class="s3">, </span><span class="s1">param_ranges</span><span class="s3">: </span><span class="s1">dict </span><span class="s3">= </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">]:</span>
    <span class="s5">&quot;&quot;&quot; 
    生成合成的训练数据 
 
    Args: 
        num_samples: 要生成的样本数量 
        param_ranges: 可选的参数范围字典，如果为None则使用默认范围 
 
    Returns: 
        Tuple[np.ndarray, np.ndarray]: 训练数据和验证数据 
    &quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s0"># 使用提供的参数范围或默认范围</span>
        <span class="s1">ranges </span><span class="s3">= </span><span class="s1">param_ranges </span><span class="s2">if </span><span class="s1">param_ranges </span><span class="s2">is not None else </span><span class="s1">PARAM_RANGES</span>

        <span class="s0"># 生成随机参数</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;开始生成随机参数...&quot;</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">i </span><span class="s3">% </span><span class="s7">100 </span><span class="s3">== </span><span class="s7">0</span><span class="s3">:  </span><span class="s0"># 每生成100个样本显示一次进度</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;进度: </span><span class="s6">{</span><span class="s1">i</span><span class="s6">}</span><span class="s4">/</span><span class="s6">{</span><span class="s1">num_samples</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

            <span class="s1">params </span><span class="s3">= []</span>
            <span class="s2">for </span><span class="s1">feature </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">:</span>
                <span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">step </span><span class="s3">= </span><span class="s1">ranges</span><span class="s3">[</span><span class="s1">feature</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">feature </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'bottom_layers'</span><span class="s3">, </span><span class="s4">'print_mode'</span><span class="s3">]:</span>
                    <span class="s0"># 对于整数参数，使用整数步长</span>
                    <span class="s1">value </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val </span><span class="s3">+ </span><span class="s7">1</span><span class="s3">))</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s0"># 对于连续参数，在范围内随机采样</span>
                    <span class="s1">value </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">)</span>
                <span class="s1">params</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
            <span class="s1">X</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">params</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;参数生成完成，共 </span><span class="s6">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span><span class="s6">} </span><span class="s4">组&quot;</span><span class="s3">)</span>

        <span class="s0"># 生成对应的质量评分</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;开始生成质量评分...&quot;</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">params </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">i </span><span class="s3">% </span><span class="s7">100 </span><span class="s3">== </span><span class="s7">0</span><span class="s3">:  </span><span class="s0"># 显示进度</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;质量评分进度: </span><span class="s6">{</span><span class="s1">i</span><span class="s6">}</span><span class="s4">/</span><span class="s6">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">y</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">generate_quality_scores</span><span class="s3">(</span><span class="s1">params</span><span class="s3">))</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;质量评分生成完成&quot;</span><span class="s3">)</span>

        <span class="s0"># 将数据集分为训练集和验证集</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;划分训练集和验证集...&quot;</span><span class="s3">)</span>
        <span class="s1">indices </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">permutation</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">)</span>
        <span class="s1">split_point </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">num_samples </span><span class="s3">* </span><span class="s7">0.8</span><span class="s3">)  </span><span class="s0"># 80%用于训练</span>

        <span class="s1">train_indices </span><span class="s3">= </span><span class="s1">indices</span><span class="s3">[:</span><span class="s1">split_point</span><span class="s3">]</span>
        <span class="s1">val_indices </span><span class="s3">= </span><span class="s1">indices</span><span class="s3">[</span><span class="s1">split_point</span><span class="s3">:]</span>

        <span class="s1">train_data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">column_stack</span><span class="s3">((</span><span class="s1">X</span><span class="s3">[</span><span class="s1">train_indices</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">train_indices</span><span class="s3">]))</span>
        <span class="s1">val_data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">column_stack</span><span class="s3">((</span><span class="s1">X</span><span class="s3">[</span><span class="s1">val_indices</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">val_indices</span><span class="s3">]))</span>

        <span class="s0"># 创建数据目录（如果不存在）</span>
        <span class="s1">data_dir </span><span class="s3">= </span><span class="s4">'data'</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">data_dir</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">data_dir</span><span class="s3">)</span>

        <span class="s0"># 保存数据集</span>
        <span class="s1">timestamp </span><span class="s3">= </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">now</span><span class="s3">().</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">&quot;%Y%m%d_%H%M%S&quot;</span><span class="s3">)</span>
        <span class="s1">header </span><span class="s3">= </span><span class="s4">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">input_features </span><span class="s3">+ </span><span class="s1">quality_score_components</span><span class="s3">)</span>

        <span class="s1">train_file </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">data_dir</span><span class="s3">, </span><span class="s4">f'train_data_</span><span class="s6">{</span><span class="s1">timestamp</span><span class="s6">}</span><span class="s4">.csv'</span><span class="s3">)</span>
        <span class="s1">val_file </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">data_dir</span><span class="s3">, </span><span class="s4">f'val_data_</span><span class="s6">{</span><span class="s1">timestamp</span><span class="s6">}</span><span class="s4">.csv'</span><span class="s3">)</span>

        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;保存数据到文件...&quot;</span><span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">savetxt</span><span class="s3">(</span><span class="s1">train_file</span><span class="s3">, </span><span class="s1">train_data</span><span class="s3">, </span><span class="s1">delimiter</span><span class="s3">=</span><span class="s4">','</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s1">header</span><span class="s3">, </span><span class="s1">comments</span><span class="s3">=</span><span class="s4">''</span><span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">savetxt</span><span class="s3">(</span><span class="s1">val_file</span><span class="s3">, </span><span class="s1">val_data</span><span class="s3">, </span><span class="s1">delimiter</span><span class="s3">=</span><span class="s4">','</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s1">header</span><span class="s3">, </span><span class="s1">comments</span><span class="s3">=</span><span class="s4">''</span><span class="s3">)</span>

        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">数据集生成完成！&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;训练集样本数: </span><span class="s6">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">train_data</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;验证集样本数: </span><span class="s6">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">val_data</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">文件已保存:&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;- 训练集: </span><span class="s6">{</span><span class="s1">train_file</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;- 验证集: </span><span class="s6">{</span><span class="s1">val_file</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">train_data</span><span class="s3">, </span><span class="s1">val_data</span>

    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;生成数据时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;生成数据时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s0"># 返回空数组，而不是None</span>
        <span class="s1">empty </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s7">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">) + </span><span class="s1">len</span><span class="s3">(</span><span class="s1">quality_score_components</span><span class="s3">)))</span>
        <span class="s2">return </span><span class="s1">empty</span><span class="s3">, </span><span class="s1">empty</span>


<span class="s2">def </span><span class="s1">generate_quality_scores</span><span class="s3">(</span><span class="s1">params</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;基于输入参数生成质量评分&quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s0"># 获取打印方式并定义其影响因子</span>
        <span class="s1">print_mode </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'print_mode'</span><span class="s3">)])</span>
        <span class="s1">mode_factors </span><span class="s3">= {</span>
            <span class="s7">0</span><span class="s3">: {</span><span class="s4">'definition'</span><span class="s3">: </span><span class="s7">1.0</span><span class="s3">, </span><span class="s4">'adhesion'</span><span class="s3">: </span><span class="s7">0.9</span><span class="s3">, </span><span class="s4">'height'</span><span class="s3">: </span><span class="s7">1.0</span><span class="s3">},  </span><span class="s0"># 连续打印</span>
            <span class="s7">1</span><span class="s3">: {</span><span class="s4">'definition'</span><span class="s3">: </span><span class="s7">0.95</span><span class="s3">, </span><span class="s4">'adhesion'</span><span class="s3">: </span><span class="s7">1.0</span><span class="s3">, </span><span class="s4">'height'</span><span class="s3">: </span><span class="s7">0.95</span><span class="s3">},  </span><span class="s0"># 间歇打印</span>
            <span class="s7">2</span><span class="s3">: {</span><span class="s4">'definition'</span><span class="s3">: </span><span class="s7">0.9</span><span class="s3">, </span><span class="s4">'adhesion'</span><span class="s3">: </span><span class="s7">0.95</span><span class="s3">, </span><span class="s4">'height'</span><span class="s3">: </span><span class="s7">0.9</span><span class="s3">}  </span><span class="s0"># 往复打印</span>
        <span class="s3">}</span>
        <span class="s1">mode_factor </span><span class="s3">= </span><span class="s1">mode_factors</span><span class="s3">[</span><span class="s1">print_mode</span><span class="s3">]</span>

        <span class="s0"># 基础评分生成</span>
        <span class="s1">needle_def </span><span class="s3">= (</span>
                             <span class="s7">0.4 </span><span class="s3">* (</span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'exposure_time'</span><span class="s3">)] / </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'exposure_time'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">]) +</span>
                             <span class="s7">0.3 </span><span class="s3">* (</span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'exposure_intensity'</span><span class="s3">)] /</span>
                                    <span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'exposure_intensity'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">]) +</span>
                             <span class="s7">0.2 </span><span class="s3">* (</span><span class="s7">1 </span><span class="s3">- </span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'layer_height'</span><span class="s3">)] / </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'layer_height'</span><span class="s3">][</span>
                         <span class="s7">1</span><span class="s3">]) +</span>
                             <span class="s7">0.1 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s7">0.8</span><span class="s3">, </span><span class="s7">0.1</span><span class="s3">)</span>
                     <span class="s3">) * </span><span class="s7">100 </span><span class="s3">* </span><span class="s1">mode_factor</span><span class="s3">[</span><span class="s4">'definition'</span><span class="s3">]</span>

        <span class="s1">layer_adh </span><span class="s3">= (</span>
                            <span class="s7">0.3 </span><span class="s3">* (</span><span class="s7">1 </span><span class="s3">- </span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'layer_height'</span><span class="s3">)] / </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'layer_height'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">]) +</span>
                            <span class="s7">0.3 </span><span class="s3">* (</span><span class="s7">1 </span><span class="s3">- </span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'lifting_speed'</span><span class="s3">)] / </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'lifting_speed'</span><span class="s3">][</span>
                        <span class="s7">1</span><span class="s3">]) +</span>
                            <span class="s7">0.3 </span><span class="s3">* (</span><span class="s7">1 </span><span class="s3">- </span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'liquid_speed'</span><span class="s3">)] / </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'liquid_speed'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">]) +</span>
                            <span class="s7">0.1 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s7">0.8</span><span class="s3">, </span><span class="s7">0.1</span><span class="s3">)</span>
                    <span class="s3">) * </span><span class="s7">100 </span><span class="s3">* </span><span class="s1">mode_factor</span><span class="s3">[</span><span class="s4">'adhesion'</span><span class="s3">]</span>

        <span class="s1">needle_height </span><span class="s3">= (</span>
                                <span class="s7">0.4 </span><span class="s3">* (</span><span class="s7">1 </span><span class="s3">- </span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'layer_height'</span><span class="s3">)] / </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'layer_height'</span><span class="s3">][</span>
                            <span class="s7">1</span><span class="s3">]) +</span>
                                <span class="s7">0.3 </span><span class="s3">* (</span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'bottom_layers'</span><span class="s3">)] / </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'bottom_layers'</span><span class="s3">][</span>
                            <span class="s7">1</span><span class="s3">]) +</span>
                                <span class="s7">0.3 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s7">0.8</span><span class="s3">, </span><span class="s7">0.1</span><span class="s3">)</span>
                        <span class="s3">) * </span><span class="s7">100 </span><span class="s3">* </span><span class="s1">mode_factor</span><span class="s3">[</span><span class="s4">'height'</span><span class="s3">]</span>

        <span class="s1">base_thick </span><span class="s3">= (</span>
                             <span class="s7">0.4 </span><span class="s3">* (</span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'bottom_exposure_time'</span><span class="s3">)] /</span>
                                    <span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'bottom_exposure_time'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">]) +</span>
                             <span class="s7">0.4 </span><span class="s3">* (</span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'bottom_exposure_intensity'</span><span class="s3">)] /</span>
                                    <span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'bottom_exposure_intensity'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">]) +</span>
                             <span class="s7">0.2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s7">0.8</span><span class="s3">, </span><span class="s7">0.1</span><span class="s3">)</span>
                     <span class="s3">) * </span><span class="s7">100</span>

        <span class="s1">material_cure </span><span class="s3">= (</span>
                                <span class="s7">0.3 </span><span class="s3">* (</span>
                                    <span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'exposure_time'</span><span class="s3">)] / </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'exposure_time'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">]) +</span>
                                <span class="s7">0.3 </span><span class="s3">* (</span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'exposure_intensity'</span><span class="s3">)] /</span>
                                       <span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'exposure_intensity'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">]) +</span>
                                <span class="s7">0.2 </span><span class="s3">* (</span><span class="s1">params</span><span class="s3">[</span><span class="s1">input_features</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s4">'exposure_wait'</span><span class="s3">)] / </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'exposure_wait'</span><span class="s3">][</span>
                            <span class="s7">1</span><span class="s3">]) +</span>
                                <span class="s7">0.2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s7">0.8</span><span class="s3">, </span><span class="s7">0.1</span><span class="s3">)</span>
                        <span class="s3">) * </span><span class="s7">100</span>

        <span class="s0"># 限制所有分数在0-100范围内</span>
        <span class="s1">scores </span><span class="s3">= [</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">clip</span><span class="s3">(</span><span class="s1">needle_def</span><span class="s3">, </span><span class="s7">0</span><span class="s3">, </span><span class="s7">100</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">clip</span><span class="s3">(</span><span class="s1">layer_adh</span><span class="s3">, </span><span class="s7">0</span><span class="s3">, </span><span class="s7">100</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">clip</span><span class="s3">(</span><span class="s1">needle_height</span><span class="s3">, </span><span class="s7">0</span><span class="s3">, </span><span class="s7">100</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">clip</span><span class="s3">(</span><span class="s1">base_thick</span><span class="s3">, </span><span class="s7">0</span><span class="s3">, </span><span class="s7">100</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">clip</span><span class="s3">(</span><span class="s1">material_cure</span><span class="s3">, </span><span class="s7">0</span><span class="s3">, </span><span class="s7">100</span><span class="s3">)</span>
        <span class="s3">]</span>

        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">scores</span><span class="s3">)</span>

    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;生成质量评分时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;生成质量评分时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s0"># 返回零分评分，而不是None</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">quality_score_components</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">get_hyperparameters</span><span class="s3">():</span>
    <span class="s5">&quot;&quot;&quot;获取模型超参数&quot;&quot;&quot;</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;开始设置模型超参数&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请输入模型超参数：&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;（直接按回车使用默认值）&quot;</span><span class="s3">)</span>

    <span class="s2">try</span><span class="s3">:</span>
        <span class="s0"># 获取层大小</span>
        <span class="s1">default_layers </span><span class="s3">= [</span><span class="s7">128</span><span class="s3">, </span><span class="s7">128</span><span class="s3">, </span><span class="s7">64</span><span class="s3">]</span>
        <span class="s1">layer_input </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">f&quot;隐藏层大小（用逗号分隔）[</span><span class="s6">{</span><span class="s4">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">default_layers</span><span class="s3">))</span><span class="s6">}</span><span class="s4">]: &quot;</span><span class="s3">)</span>
        <span class="s1">layer_sizes </span><span class="s3">= [</span><span class="s1">int</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">layer_input</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">','</span><span class="s3">)] </span><span class="s2">if </span><span class="s1">layer_input</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s1">default_layers</span>

        <span class="s0"># 获取训练参数</span>
        <span class="s1">epochs </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;训练轮数 [500]: &quot;</span><span class="s3">)</span>
        <span class="s1">epochs </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">epochs</span><span class="s3">) </span><span class="s2">if </span><span class="s1">epochs</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s7">500</span>

        <span class="s1">batch_size </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;批次大小 [32]: &quot;</span><span class="s3">)</span>
        <span class="s1">batch_size </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">batch_size</span><span class="s3">) </span><span class="s2">if </span><span class="s1">batch_size</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s7">32</span>

        <span class="s1">learning_rate </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;学习率 [0.001]: &quot;</span><span class="s3">)</span>
        <span class="s1">learning_rate </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">learning_rate</span><span class="s3">) </span><span class="s2">if </span><span class="s1">learning_rate</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s7">0.001</span>

        <span class="s1">patience </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;早停耐心值（轮数）[20]: &quot;</span><span class="s3">)</span>
        <span class="s1">patience </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">patience</span><span class="s3">) </span><span class="s2">if </span><span class="s1">patience</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s7">20</span>

        <span class="s1">hyperparams </span><span class="s3">= {</span>
            <span class="s4">'layer_sizes'</span><span class="s3">: </span><span class="s1">layer_sizes</span><span class="s3">,</span>
            <span class="s4">'epochs'</span><span class="s3">: </span><span class="s1">epochs</span><span class="s3">,</span>
            <span class="s4">'batch_size'</span><span class="s3">: </span><span class="s1">batch_size</span><span class="s3">,</span>
            <span class="s4">'learning_rate'</span><span class="s3">: </span><span class="s1">learning_rate</span><span class="s3">,</span>
            <span class="s4">'patience'</span><span class="s3">: </span><span class="s1">patience</span>
        <span class="s3">}</span>

        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">已选择的超参数：&quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">hyperparams</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">key</span><span class="s6">}</span><span class="s4">: </span><span class="s6">{</span><span class="s1">value</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s1">confirm </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">使用这些参数继续？(y/n) [y]: &quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">confirm</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s4">'n'</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">get_hyperparameters</span><span class="s3">()</span>

        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;超参数设置完成: </span><span class="s6">{</span><span class="s1">hyperparams</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">hyperparams</span>

    <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;参数输入错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">参数输入错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">get_hyperparameters</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">train_model</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">, </span><span class="s1">y_train</span><span class="s3">, </span><span class="s1">X_val</span><span class="s3">, </span><span class="s1">y_val</span><span class="s3">, </span><span class="s1">hyperparams</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;训练模型&quot;&quot;&quot;</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;开始训练模型&quot;</span><span class="s3">)</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s0"># 准备数据加载器</span>
        <span class="s1">train_dataset </span><span class="s3">= </span><span class="s1">TensorDataset</span><span class="s3">(</span><span class="s1">torch</span><span class="s3">.</span><span class="s1">from_numpy</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">), </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">from_numpy</span><span class="s3">(</span><span class="s1">y_train</span><span class="s3">))</span>
        <span class="s1">val_dataset </span><span class="s3">= </span><span class="s1">TensorDataset</span><span class="s3">(</span><span class="s1">torch</span><span class="s3">.</span><span class="s1">from_numpy</span><span class="s3">(</span><span class="s1">X_val</span><span class="s3">), </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">from_numpy</span><span class="s3">(</span><span class="s1">y_val</span><span class="s3">))</span>

        <span class="s1">train_loader </span><span class="s3">= </span><span class="s1">DataLoader</span><span class="s3">(</span><span class="s1">train_dataset</span><span class="s3">, </span><span class="s1">batch_size</span><span class="s3">=</span><span class="s1">hyperparams</span><span class="s3">[</span><span class="s4">'batch_size'</span><span class="s3">], </span><span class="s1">shuffle</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">val_loader </span><span class="s3">= </span><span class="s1">DataLoader</span><span class="s3">(</span><span class="s1">val_dataset</span><span class="s3">, </span><span class="s1">batch_size</span><span class="s3">=</span><span class="s1">hyperparams</span><span class="s3">[</span><span class="s4">'batch_size'</span><span class="s3">])</span>

        <span class="s0"># 创建模型</span>
        <span class="s1">model </span><span class="s3">= </span><span class="s1">MicroneedleQualityModel</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">quality_score_components</span><span class="s3">),</span>
                                        <span class="s1">hyperparams</span><span class="s3">[</span><span class="s4">'layer_sizes'</span><span class="s3">])</span>

        <span class="s0"># 检查CUDA可用性并移动模型到适当的设备</span>
        <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cuda&quot; </span><span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">() </span><span class="s2">else </span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>
        <span class="s1">model </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">to</span><span class="s3">(</span><span class="s1">device</span><span class="s3">)</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;模型已加载到设备: </span><span class="s6">{</span><span class="s1">device</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s1">criterion </span><span class="s3">= </span><span class="s1">nn</span><span class="s3">.</span><span class="s1">MSELoss</span><span class="s3">()</span>
        <span class="s1">optimizer </span><span class="s3">= </span><span class="s1">optim</span><span class="s3">.</span><span class="s1">Adam</span><span class="s3">(</span><span class="s1">model</span><span class="s3">.</span><span class="s1">parameters</span><span class="s3">(), </span><span class="s1">lr</span><span class="s3">=</span><span class="s1">hyperparams</span><span class="s3">[</span><span class="s4">'learning_rate'</span><span class="s3">])</span>
        <span class="s1">scheduler </span><span class="s3">= </span><span class="s1">optim</span><span class="s3">.</span><span class="s1">lr_scheduler</span><span class="s3">.</span><span class="s1">ReduceLROnPlateau</span><span class="s3">(</span><span class="s1">optimizer</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'min'</span><span class="s3">, </span><span class="s1">factor</span><span class="s3">=</span><span class="s7">0.5</span><span class="s3">, </span><span class="s1">patience</span><span class="s3">=</span><span class="s7">5</span><span class="s3">)</span>

        <span class="s1">best_loss </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
        <span class="s1">best_epoch </span><span class="s3">= </span><span class="s7">0</span>
        <span class="s1">best_model_weights </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">no_improve_count </span><span class="s3">= </span><span class="s7">0</span>

        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">训练进度：&quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">epoch </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">hyperparams</span><span class="s3">[</span><span class="s4">'epochs'</span><span class="s3">]):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s0"># 训练阶段</span>
                <span class="s1">model</span><span class="s3">.</span><span class="s1">train</span><span class="s3">()</span>
                <span class="s1">train_loss </span><span class="s3">= </span><span class="s7">0</span>
                <span class="s2">for </span><span class="s1">inputs</span><span class="s3">, </span><span class="s1">targets </span><span class="s2">in </span><span class="s1">train_loader</span><span class="s3">:</span>
                    <span class="s1">inputs</span><span class="s3">, </span><span class="s1">targets </span><span class="s3">= </span><span class="s1">inputs</span><span class="s3">.</span><span class="s1">to</span><span class="s3">(</span><span class="s1">device</span><span class="s3">), </span><span class="s1">targets</span><span class="s3">.</span><span class="s1">to</span><span class="s3">(</span><span class="s1">device</span><span class="s3">)</span>
                    <span class="s1">inputs </span><span class="s3">= </span><span class="s1">inputs</span><span class="s3">.</span><span class="s1">float</span><span class="s3">()</span>
                    <span class="s1">targets </span><span class="s3">= </span><span class="s1">targets</span><span class="s3">.</span><span class="s1">float</span><span class="s3">()</span>

                    <span class="s1">optimizer</span><span class="s3">.</span><span class="s1">zero_grad</span><span class="s3">()</span>
                    <span class="s1">outputs </span><span class="s3">= </span><span class="s1">model</span><span class="s3">(</span><span class="s1">inputs</span><span class="s3">)</span>
                    <span class="s1">loss </span><span class="s3">= </span><span class="s1">criterion</span><span class="s3">(</span><span class="s1">outputs</span><span class="s3">, </span><span class="s1">targets</span><span class="s3">)</span>
                    <span class="s1">loss</span><span class="s3">.</span><span class="s1">backward</span><span class="s3">()</span>
                    <span class="s1">optimizer</span><span class="s3">.</span><span class="s1">step</span><span class="s3">()</span>
                    <span class="s1">train_loss </span><span class="s3">+= </span><span class="s1">loss</span><span class="s3">.</span><span class="s1">item</span><span class="s3">()</span>

                <span class="s1">train_loss </span><span class="s3">/= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">train_loader</span><span class="s3">)</span>

                <span class="s0"># 评估阶段</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">epoch </span><span class="s3">+ </span><span class="s7">1</span><span class="s3">) % </span><span class="s7">10 </span><span class="s3">== </span><span class="s7">0</span><span class="s3">:  </span><span class="s0"># 每10轮评估一次</span>
                    <span class="s1">metrics </span><span class="s3">= </span><span class="s1">evaluate_model</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">val_loader</span><span class="s3">, </span><span class="s1">device</span><span class="s3">)</span>
                    <span class="s1">current_loss </span><span class="s3">= </span><span class="s1">metrics</span><span class="s3">[</span><span class="s4">'total_mse'</span><span class="s3">]</span>

                    <span class="s0"># 学习率调整</span>
                    <span class="s1">scheduler</span><span class="s3">.</span><span class="s1">step</span><span class="s3">(</span><span class="s1">current_loss</span><span class="s3">)</span>
                    <span class="s1">current_lr </span><span class="s3">= </span><span class="s1">optimizer</span><span class="s3">.</span><span class="s1">param_groups</span><span class="s3">[</span><span class="s7">0</span><span class="s3">][</span><span class="s4">'lr'</span><span class="s3">]</span>

                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">============ 第 </span><span class="s6">{</span><span class="s1">epoch </span><span class="s3">+ </span><span class="s7">1</span><span class="s6">} </span><span class="s4">轮评估结果 ============&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;训练损失: </span><span class="s6">{</span><span class="s1">train_loss</span><span class="s6">:</span><span class="s4">.4f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;验证损失: </span><span class="s6">{</span><span class="s1">current_loss</span><span class="s6">:</span><span class="s4">.4f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;当前学习率: </span><span class="s6">{</span><span class="s1">current_lr</span><span class="s6">:</span><span class="s4">.6f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;总体评估等级: </span><span class="s6">{</span><span class="s1">metrics</span><span class="s3">[</span><span class="s4">'quality_level'</span><span class="s3">]</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;各组件MSE损失:&quot;</span><span class="s3">)</span>
                    <span class="s2">for </span><span class="s1">comp</span><span class="s3">, </span><span class="s1">mse </span><span class="s2">in </span><span class="s1">metrics</span><span class="s3">[</span><span class="s4">'component_mse'</span><span class="s3">].</span><span class="s1">items</span><span class="s3">():</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;  </span><span class="s6">{</span><span class="s1">comp</span><span class="s6">}</span><span class="s4">: </span><span class="s6">{</span><span class="s1">mse</span><span class="s6">:</span><span class="s4">.4f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;最大预测误差: </span><span class="s6">{</span><span class="s1">metrics</span><span class="s3">[</span><span class="s4">'max_error'</span><span class="s3">]</span><span class="s6">:</span><span class="s4">.4f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;=&quot; </span><span class="s3">* </span><span class="s7">45</span><span class="s3">)</span>

                    <span class="s0"># 保存最佳模型</span>
                    <span class="s2">if </span><span class="s1">current_loss </span><span class="s3">&lt; </span><span class="s1">best_loss</span><span class="s3">:</span>
                        <span class="s1">best_loss </span><span class="s3">= </span><span class="s1">current_loss</span>
                        <span class="s1">best_epoch </span><span class="s3">= </span><span class="s1">epoch</span>
                        <span class="s1">best_model_weights </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">state_dict</span><span class="s3">()</span>
                        <span class="s1">no_improve_count </span><span class="s3">= </span><span class="s7">0</span>
                        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;第 </span><span class="s6">{</span><span class="s1">epoch </span><span class="s3">+ </span><span class="s7">1</span><span class="s6">} </span><span class="s4">轮更新最佳模型，验证损失: </span><span class="s6">{</span><span class="s1">best_loss</span><span class="s6">:</span><span class="s4">.4f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">no_improve_count </span><span class="s3">+= </span><span class="s7">1</span>

                    <span class="s0"># 早停检查</span>
                    <span class="s2">if </span><span class="s1">no_improve_count </span><span class="s3">&gt;= </span><span class="s1">hyperparams</span><span class="s3">[</span><span class="s4">'patience'</span><span class="s3">]:</span>
                        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;触发早停机制，在第 </span><span class="s6">{</span><span class="s1">epoch </span><span class="s3">+ </span><span class="s7">1</span><span class="s6">} </span><span class="s4">轮停止训练&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">在轮次 </span><span class="s6">{</span><span class="s1">epoch </span><span class="s3">+ </span><span class="s7">1</span><span class="s6">} </span><span class="s4">处提前停止&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;最佳验证损失: </span><span class="s6">{</span><span class="s1">best_loss</span><span class="s6">:</span><span class="s4">.4f</span><span class="s6">} </span><span class="s4">(轮次 </span><span class="s6">{</span><span class="s1">best_epoch </span><span class="s3">+ </span><span class="s7">1</span><span class="s6">}</span><span class="s4">)&quot;</span><span class="s3">)</span>
                        <span class="s1">model</span><span class="s3">.</span><span class="s1">load_state_dict</span><span class="s3">(</span><span class="s1">best_model_weights</span><span class="s3">)</span>
                        <span class="s2">break</span>

            <span class="s2">except </span><span class="s1">KeyboardInterrupt</span><span class="s3">:</span>
                <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;训练被用户中断&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">训练被中断。保存当前最佳模型...&quot;</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">best_model_weights </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">model</span><span class="s3">.</span><span class="s1">load_state_dict</span><span class="s3">(</span><span class="s1">best_model_weights</span><span class="s3">)</span>
                <span class="s2">break</span>
            <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;训练过程中出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                <span class="s2">raise</span>

        <span class="s0"># 确保模型使用最佳权重</span>
        <span class="s2">if </span><span class="s1">best_model_weights </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">model</span><span class="s3">.</span><span class="s1">load_state_dict</span><span class="s3">(</span><span class="s1">best_model_weights</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">model</span><span class="s3">, </span><span class="s1">best_loss</span>

    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;训练过程中出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">raise</span>


<span class="s2">def </span><span class="s1">evaluate_model</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">val_loader</span><span class="s3">, </span><span class="s1">device</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;详细评估模型性能&quot;&quot;&quot;</span>
    <span class="s1">model</span><span class="s3">.</span><span class="s1">eval</span><span class="s3">()</span>
    <span class="s1">component_mse </span><span class="s3">= {</span><span class="s1">comp</span><span class="s3">: [] </span><span class="s2">for </span><span class="s1">comp </span><span class="s2">in </span><span class="s1">quality_score_components</span><span class="s3">}</span>
    <span class="s1">overall_predictions </span><span class="s3">= []</span>
    <span class="s1">overall_targets </span><span class="s3">= []</span>

    <span class="s2">with </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">no_grad</span><span class="s3">():</span>
        <span class="s2">for </span><span class="s1">inputs</span><span class="s3">, </span><span class="s1">targets </span><span class="s2">in </span><span class="s1">val_loader</span><span class="s3">:</span>
            <span class="s1">inputs</span><span class="s3">, </span><span class="s1">targets </span><span class="s3">= </span><span class="s1">inputs</span><span class="s3">.</span><span class="s1">to</span><span class="s3">(</span><span class="s1">device</span><span class="s3">), </span><span class="s1">targets</span><span class="s3">.</span><span class="s1">to</span><span class="s3">(</span><span class="s1">device</span><span class="s3">)</span>
            <span class="s1">outputs </span><span class="s3">= </span><span class="s1">model</span><span class="s3">(</span><span class="s1">inputs</span><span class="s3">.</span><span class="s1">float</span><span class="s3">())</span>

            <span class="s0"># 计算每个组件的MSE</span>
            <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">comp </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">quality_score_components</span><span class="s3">):</span>
                <span class="s1">mse </span><span class="s3">= </span><span class="s1">nn</span><span class="s3">.</span><span class="s1">MSELoss</span><span class="s3">()(</span><span class="s1">outputs</span><span class="s3">[:, </span><span class="s1">i</span><span class="s3">], </span><span class="s1">targets</span><span class="s3">[:, </span><span class="s1">i</span><span class="s3">])</span>
                <span class="s1">component_mse</span><span class="s3">[</span><span class="s1">comp</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">mse</span><span class="s3">.</span><span class="s1">item</span><span class="s3">())</span>

            <span class="s0"># 收集预测结果</span>
            <span class="s1">overall_predictions</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">outputs</span><span class="s3">.</span><span class="s1">cpu</span><span class="s3">().</span><span class="s1">numpy</span><span class="s3">())</span>
            <span class="s1">overall_targets</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">cpu</span><span class="s3">().</span><span class="s1">numpy</span><span class="s3">())</span>

    <span class="s0"># 计算评估指标</span>
    <span class="s1">metrics </span><span class="s3">= {</span>
        <span class="s4">'component_mse'</span><span class="s3">: {</span><span class="s1">comp</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">losses</span><span class="s3">) </span><span class="s2">for </span><span class="s1">comp</span><span class="s3">, </span><span class="s1">losses </span><span class="s2">in </span><span class="s1">component_mse</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()},</span>
        <span class="s4">'total_mse'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">losses</span><span class="s3">) </span><span class="s2">for </span><span class="s1">losses </span><span class="s2">in </span><span class="s1">component_mse</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()]),</span>
        <span class="s4">'max_error'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">overall_predictions</span><span class="s3">) - </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">overall_targets</span><span class="s3">)))</span>
    <span class="s3">}</span>

    <span class="s0"># 评估质量等级</span>
    <span class="s2">if </span><span class="s1">metrics</span><span class="s3">[</span><span class="s4">'total_mse'</span><span class="s3">] &lt; </span><span class="s7">25</span><span class="s3">:</span>
        <span class="s1">quality_level </span><span class="s3">= </span><span class="s4">'优秀'</span>
    <span class="s2">elif </span><span class="s1">metrics</span><span class="s3">[</span><span class="s4">'total_mse'</span><span class="s3">] &lt; </span><span class="s7">100</span><span class="s3">:</span>
        <span class="s1">quality_level </span><span class="s3">= </span><span class="s4">'良好'</span>
    <span class="s2">elif </span><span class="s1">metrics</span><span class="s3">[</span><span class="s4">'total_mse'</span><span class="s3">] &lt; </span><span class="s7">225</span><span class="s3">:</span>
        <span class="s1">quality_level </span><span class="s3">= </span><span class="s4">'一般'</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">quality_level </span><span class="s3">= </span><span class="s4">'需改进'</span>

    <span class="s1">metrics</span><span class="s3">[</span><span class="s4">'quality_level'</span><span class="s3">] = </span><span class="s1">quality_level</span>

    <span class="s2">return </span><span class="s1">metrics</span>


<span class="s2">def </span><span class="s1">save_model</span><span class="s3">(</span><span class="s1">model</span><span class="s3">: </span><span class="s1">nn</span><span class="s3">.</span><span class="s1">Module</span><span class="s3">, </span><span class="s1">hyperparams</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">, </span><span class="s1">loss</span><span class="s3">: </span><span class="s1">float</span><span class="s3">, </span><span class="s1">filename_prefix</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">'model'</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;保存模型权重和配置信息&quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">timestamp </span><span class="s3">= </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">now</span><span class="s3">().</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">&quot;%Y%m%d_%H%M%S&quot;</span><span class="s3">)</span>

        <span class="s0"># 确保models目录存在</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">)</span>

        <span class="s0"># 保存模型权重</span>
        <span class="s1">model_filename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">, </span><span class="s4">f'</span><span class="s6">{</span><span class="s1">filename_prefix</span><span class="s6">}</span><span class="s4">_</span><span class="s6">{</span><span class="s1">timestamp</span><span class="s6">}</span><span class="s4">.pth'</span><span class="s3">)</span>
        <span class="s1">torch</span><span class="s3">.</span><span class="s1">save</span><span class="s3">(</span><span class="s1">model</span><span class="s3">.</span><span class="s1">state_dict</span><span class="s3">(), </span><span class="s1">model_filename</span><span class="s3">)</span>

        <span class="s0"># 保存超参数和训练信息</span>
        <span class="s1">info </span><span class="s3">= {</span>
            <span class="s4">'hyperparameters'</span><span class="s3">: </span><span class="s1">hyperparams</span><span class="s3">,</span>
            <span class="s4">'best_validation_loss'</span><span class="s3">: </span><span class="s1">float</span><span class="s3">(</span><span class="s1">loss</span><span class="s3">),</span>
            <span class="s4">'input_features'</span><span class="s3">: </span><span class="s1">input_features</span><span class="s3">,</span>
            <span class="s4">'quality_components'</span><span class="s3">: </span><span class="s1">quality_score_components</span><span class="s3">,</span>
            <span class="s4">'quality_weights'</span><span class="s3">: </span><span class="s1">quality_score_weights</span><span class="s3">,</span>
            <span class="s4">'param_ranges'</span><span class="s3">: </span><span class="s1">PARAM_RANGES</span><span class="s3">,</span>
            <span class="s4">'timestamp'</span><span class="s3">: </span><span class="s1">timestamp</span><span class="s3">,</span>
            <span class="s4">'model_file'</span><span class="s3">: </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">model_filename</span><span class="s3">),</span>
            <span class="s4">'torch_version'</span><span class="s3">: </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">,</span>
            <span class="s4">'cuda_version'</span><span class="s3">: </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">version</span><span class="s3">.</span><span class="s1">cuda </span><span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">() </span><span class="s2">else None</span>
        <span class="s3">}</span>

        <span class="s1">info_filename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">, </span><span class="s4">f'</span><span class="s6">{</span><span class="s1">filename_prefix</span><span class="s6">}</span><span class="s4">_</span><span class="s6">{</span><span class="s1">timestamp</span><span class="s6">}</span><span class="s4">_info.json'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">info_filename</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf-8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">json</span><span class="s3">.</span><span class="s1">dump</span><span class="s3">(</span><span class="s1">info</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">=</span><span class="s7">4</span><span class="s3">, </span><span class="s1">ensure_ascii</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;模型已保存至 </span><span class="s6">{</span><span class="s1">model_filename</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;模型信息已保存至 </span><span class="s6">{</span><span class="s1">info_filename</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">模型已保存至 </span><span class="s6">{</span><span class="s1">model_filename</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;模型信息已保存至 </span><span class="s6">{</span><span class="s1">info_filename</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">model_filename</span><span class="s3">, </span><span class="s1">info_filename</span>

    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;保存模型时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">错误: 保存模型时出现问题: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">return None</span><span class="s3">, </span><span class="s2">None</span>

<span class="s2">def </span><span class="s1">predict_quality</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">device</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot; 
    预测质量并提供可信度评估 
 
    Args: 
        model: 训练好的模型 
        params: 输入参数字典 
        device: 计算设备（如果为None则自动检测） 
 
    Returns: 
        dict: 包含预测结果和可信度的字典 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">device </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cuda&quot; </span><span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">() </span><span class="s2">else </span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>

    <span class="s1">model</span><span class="s3">.</span><span class="s1">eval</span><span class="s3">()</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s0"># 准备输入数据</span>
        <span class="s1">input_vec </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">params</span><span class="s3">[</span><span class="s1">f</span><span class="s3">] </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">])</span>
        <span class="s1">input_tensor </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">from_numpy</span><span class="s3">(</span><span class="s1">input_vec</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)).</span><span class="s1">to</span><span class="s3">(</span><span class="s1">device</span><span class="s3">)</span>

        <span class="s0"># 添加batch维度</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_tensor</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">) == </span><span class="s7">1</span><span class="s3">:</span>
            <span class="s1">input_tensor </span><span class="s3">= </span><span class="s1">input_tensor</span><span class="s3">.</span><span class="s1">unsqueeze</span><span class="s3">(</span><span class="s7">0</span><span class="s3">)</span>

        <span class="s0"># 进行预测</span>
        <span class="s2">with </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">no_grad</span><span class="s3">():</span>
            <span class="s1">output_tensor </span><span class="s3">= </span><span class="s1">model</span><span class="s3">(</span><span class="s1">input_tensor</span><span class="s3">)</span>
            <span class="s1">output_vec </span><span class="s3">= </span><span class="s1">output_tensor</span><span class="s3">.</span><span class="s1">cpu</span><span class="s3">().</span><span class="s1">numpy</span><span class="s3">()[</span><span class="s7">0</span><span class="s3">]  </span><span class="s0"># 取出第一个样本的结果</span>

        <span class="s0"># 获取预测结果</span>
        <span class="s1">output_dict </span><span class="s3">= {</span><span class="s1">comp</span><span class="s3">: </span><span class="s1">output_vec</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">comp </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">quality_score_components</span><span class="s3">)}</span>

        <span class="s0"># 计算综合质量分数</span>
        <span class="s1">overall_score </span><span class="s3">= </span><span class="s1">sum</span><span class="s3">(</span><span class="s1">output_dict</span><span class="s3">[</span><span class="s1">comp</span><span class="s3">] * </span><span class="s1">quality_score_weights</span><span class="s3">[</span><span class="s1">comp</span><span class="s3">]</span>
                            <span class="s2">for </span><span class="s1">comp </span><span class="s2">in </span><span class="s1">quality_score_components</span><span class="s3">)</span>

        <span class="s0"># 评估预测可信度</span>
        <span class="s1">prediction_confidence </span><span class="s3">= </span><span class="s4">&quot;高&quot; </span><span class="s2">if </span><span class="s1">all</span><span class="s3">(</span><span class="s7">0 </span><span class="s3">&lt;= </span><span class="s1">score </span><span class="s3">&lt;= </span><span class="s7">100 </span><span class="s2">for </span><span class="s1">score </span><span class="s2">in </span><span class="s1">output_vec</span><span class="s3">) </span><span class="s2">else </span><span class="s4">&quot;低&quot;</span>

        <span class="s0"># 评估各组件预测可信度</span>
        <span class="s1">component_confidence </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">comp</span><span class="s3">, </span><span class="s1">score </span><span class="s2">in </span><span class="s1">output_dict</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s7">0 </span><span class="s3">&lt;= </span><span class="s1">score </span><span class="s3">&lt;= </span><span class="s7">100</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s7">20 </span><span class="s3">&lt;= </span><span class="s1">score </span><span class="s3">&lt;= </span><span class="s7">90</span><span class="s3">:  </span><span class="s0"># 在一个更合理的范围内</span>
                    <span class="s1">component_confidence</span><span class="s3">[</span><span class="s1">comp</span><span class="s3">] = </span><span class="s4">&quot;高&quot;</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">component_confidence</span><span class="s3">[</span><span class="s1">comp</span><span class="s3">] = </span><span class="s4">&quot;中&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">component_confidence</span><span class="s3">[</span><span class="s1">comp</span><span class="s3">] = </span><span class="s4">&quot;低&quot;</span>

        <span class="s0"># 生成参数优化建议</span>
        <span class="s1">optimization_suggestions </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">comp</span><span class="s3">, </span><span class="s1">score </span><span class="s2">in </span><span class="s1">output_dict</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">score </span><span class="s3">&lt; </span><span class="s7">70</span><span class="s3">:</span>
                <span class="s1">suggestions </span><span class="s3">= </span><span class="s1">get_optimization_suggestions</span><span class="s3">(</span><span class="s1">comp</span><span class="s3">, </span><span class="s1">params</span><span class="s3">)</span>
                <span class="s1">optimization_suggestions</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">suggestions</span><span class="s3">)</span>

        <span class="s0"># 基于打印方式添加特殊提示</span>
        <span class="s1">mode_value </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'print_mode'</span><span class="s3">])</span>
        <span class="s1">mode_tips </span><span class="s3">= {</span>
            <span class="s7">0</span><span class="s3">: </span><span class="s4">&quot;连续打印模式下建议注意:</span><span class="s6">\n</span><span class="s4">- 保持稳定的打印速度</span><span class="s6">\n</span><span class="s4">- 确保材料供应充足</span><span class="s6">\n</span><span class="s4">- 监控温度变化&quot;</span><span class="s3">,</span>
            <span class="s7">1</span><span class="s3">: </span><span class="s4">&quot;间歇打印模式下建议注意:</span><span class="s6">\n</span><span class="s4">- 控制等待时间</span><span class="s6">\n</span><span class="s4">- 确保层间结合</span><span class="s6">\n</span><span class="s4">- 避免过度冷却&quot;</span><span class="s3">,</span>
            <span class="s7">2</span><span class="s3">: </span><span class="s4">&quot;往复打印模式下建议注意:</span><span class="s6">\n</span><span class="s4">- 优化往复速度</span><span class="s6">\n</span><span class="s4">- 监控材料流动性</span><span class="s6">\n</span><span class="s4">- 注意表面质量&quot;</span>
        <span class="s3">}</span>

        <span class="s2">return </span><span class="s3">{</span>
            <span class="s4">'component_scores'</span><span class="s3">: </span><span class="s1">output_dict</span><span class="s3">,</span>
            <span class="s4">'overall_score'</span><span class="s3">: </span><span class="s1">overall_score</span><span class="s3">,</span>
            <span class="s4">'prediction_confidence'</span><span class="s3">: </span><span class="s1">prediction_confidence</span><span class="s3">,</span>
            <span class="s4">'component_confidence'</span><span class="s3">: </span><span class="s1">component_confidence</span><span class="s3">,</span>
            <span class="s4">'optimization_suggestions'</span><span class="s3">: </span><span class="s1">optimization_suggestions</span><span class="s3">,</span>
            <span class="s4">'print_mode_tip'</span><span class="s3">: </span><span class="s1">mode_tips</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">mode_value</span><span class="s3">, </span><span class="s4">&quot;未知打印模式&quot;</span><span class="s3">),</span>
            <span class="s4">'timestamp'</span><span class="s3">: </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">now</span><span class="s3">().</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="s3">)</span>
        <span class="s3">}</span>

    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;预测过程中出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">raise</span>


<span class="s2">def </span><span class="s1">get_optimization_suggestions</span><span class="s3">(</span><span class="s1">component</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">current_params</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s5">&quot;&quot;&quot;根据组件得分生成优化建议&quot;&quot;&quot;</span>
    <span class="s1">suggestions </span><span class="s3">= []</span>

    <span class="s2">if </span><span class="s1">component </span><span class="s3">== </span><span class="s4">'needle_definition'</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'exposure_time'</span><span class="s3">] &lt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'exposure_time'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.7</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;考虑适当增加曝光时间&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'exposure_intensity'</span><span class="s3">] &lt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'exposure_intensity'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.7</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;可以提高曝光强度&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'layer_height'</span><span class="s3">] &gt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'layer_height'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.3</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;建议减小层高以提高精度&quot;</span><span class="s3">)</span>

    <span class="s2">elif </span><span class="s1">component </span><span class="s3">== </span><span class="s4">'layer_adhesion'</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'lifting_speed'</span><span class="s3">] &gt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'lifting_speed'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.7</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;建议降低抬升速度&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'liquid_speed'</span><span class="s3">] &gt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'liquid_speed'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.7</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;可以适当降低入液速度&quot;</span><span class="s3">)</span>

    <span class="s2">elif </span><span class="s1">component </span><span class="s3">== </span><span class="s4">'needle_height'</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'bottom_layers'</span><span class="s3">] &lt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'bottom_layers'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.5</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;可以增加底层数量&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'layer_height'</span><span class="s3">] &gt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'layer_height'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.3</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;考虑减小层高以提高精确度&quot;</span><span class="s3">)</span>

    <span class="s2">elif </span><span class="s1">component </span><span class="s3">== </span><span class="s4">'base_thickness'</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'bottom_exposure_time'</span><span class="s3">] &lt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'bottom_exposure_time'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.7</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;建议增加底层曝光时间&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'bottom_exposure_intensity'</span><span class="s3">] &lt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'bottom_exposure_intensity'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.7</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;可以提高底层曝光强度&quot;</span><span class="s3">)</span>

    <span class="s2">elif </span><span class="s1">component </span><span class="s3">== </span><span class="s4">'material_curing'</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'exposure_time'</span><span class="s3">] &lt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'exposure_time'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.7</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;建议增加曝光时间&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">current_params</span><span class="s3">[</span><span class="s4">'exposure_wait'</span><span class="s3">] &lt; </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s4">'exposure_wait'</span><span class="s3">][</span><span class="s7">1</span><span class="s3">] * </span><span class="s7">0.5</span><span class="s3">:</span>
            <span class="s1">suggestions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">&quot;可以适当增加曝光等待时间&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">suggestions</span>


<span class="s2">def </span><span class="s1">find_optimal_parameters</span><span class="s3">(</span><span class="s1">model</span><span class="s3">: </span><span class="s1">nn</span><span class="s3">.</span><span class="s1">Module</span><span class="s3">, </span><span class="s1">num_combinations</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s7">1000</span><span class="s3">,</span>
                            <span class="s1">constraints</span><span class="s3">: </span><span class="s1">dict </span><span class="s3">= </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">Dict</span><span class="s3">], </span><span class="s1">Dict</span><span class="s3">]:</span>
    <span class="s5">&quot;&quot;&quot; 
    搜索最佳打印参数组合 
 
    Args: 
        model: 训练好的模型 
        num_combinations: 要测试的参数组合数量 
        constraints: 参数约束条件 
 
    Returns: 
        Tuple[List[Dict], Dict]: 最佳参数组合列表和参数分析结果 
    &quot;&quot;&quot;</span>
    <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cuda&quot; </span><span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">() </span><span class="s2">else </span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>
    <span class="s1">model </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">to</span><span class="s3">(</span><span class="s1">device</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">generate_param_combination</span><span class="s3">():</span>
        <span class="s5">&quot;&quot;&quot;生成一组随机参数组合&quot;&quot;&quot;</span>
        <span class="s1">params </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">param</span><span class="s3">, (</span><span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">step</span><span class="s3">) </span><span class="s2">in </span><span class="s1">PARAM_RANGES</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">constraints </span><span class="s2">and </span><span class="s1">param </span><span class="s2">in </span><span class="s1">constraints</span><span class="s3">:</span>
                <span class="s0"># 使用约束条件中的范围</span>
                <span class="s1">c_min</span><span class="s3">, </span><span class="s1">c_max </span><span class="s3">= </span><span class="s1">constraints</span><span class="s3">[</span><span class="s1">param</span><span class="s3">]</span>
                <span class="s1">min_val </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">min_val</span><span class="s3">, </span><span class="s1">c_min</span><span class="s3">)</span>
                <span class="s1">max_val </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">c_max</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">param </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'bottom_layers'</span><span class="s3">, </span><span class="s4">'print_mode'</span><span class="s3">]:</span>
                <span class="s1">possible_values </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val </span><span class="s3">+ </span><span class="s1">step</span><span class="s3">, </span><span class="s1">step</span><span class="s3">)</span>
                <span class="s1">params</span><span class="s3">[</span><span class="s1">param</span><span class="s3">] = </span><span class="s1">float</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">choice</span><span class="s3">(</span><span class="s1">possible_values</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">params</span><span class="s3">[</span><span class="s1">param</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">params</span>

    <span class="s2">def </span><span class="s1">evaluate_combination</span><span class="s3">(</span><span class="s1">params</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">str</span><span class="s3">, </span><span class="s1">Dict</span><span class="s3">, </span><span class="s1">Dict</span><span class="s3">]:</span>
        <span class="s5">&quot;&quot;&quot;评估一组参数组合的质量分数&quot;&quot;&quot;</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">prediction_results </span><span class="s3">= </span><span class="s1">predict_quality</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">device</span><span class="s3">)</span>
            <span class="s1">overall_score </span><span class="s3">= </span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'overall_score'</span><span class="s3">]</span>
            <span class="s1">confidence </span><span class="s3">= </span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'prediction_confidence'</span><span class="s3">]</span>
            <span class="s2">return </span><span class="s1">overall_score</span><span class="s3">, </span><span class="s1">confidence</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">prediction_results</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;评估参数组合时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s3">-</span><span class="s7">1</span><span class="s3">, </span><span class="s4">&quot;低&quot;</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s2">None</span>

    <span class="s0"># 生成并评估参数组合</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;开始搜索最佳打印参数...&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">开始搜索最佳打印参数...&quot;</span><span class="s3">)</span>

    <span class="s1">results </span><span class="s3">= []</span>
    <span class="s1">progress_interval </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s7">1</span><span class="s3">, </span><span class="s1">num_combinations </span><span class="s3">// </span><span class="s7">20</span><span class="s3">)  </span><span class="s0"># 5%的进度显示间隔</span>

    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_combinations</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">i </span><span class="s3">+ </span><span class="s7">1</span><span class="s3">) % </span><span class="s1">progress_interval </span><span class="s3">== </span><span class="s7">0</span><span class="s3">:</span>
            <span class="s1">progress </span><span class="s3">= (</span><span class="s1">i </span><span class="s3">+ </span><span class="s7">1</span><span class="s3">) / </span><span class="s1">num_combinations </span><span class="s3">* </span><span class="s7">100</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;搜索进度: </span><span class="s6">{</span><span class="s1">progress</span><span class="s6">:</span><span class="s4">.1f</span><span class="s6">}</span><span class="s4">% (</span><span class="s6">{</span><span class="s1">i </span><span class="s3">+ </span><span class="s7">1</span><span class="s6">}</span><span class="s4">/</span><span class="s6">{</span><span class="s1">num_combinations</span><span class="s6">}</span><span class="s4">)&quot;</span><span class="s3">)</span>

        <span class="s1">params </span><span class="s3">= </span><span class="s1">generate_param_combination</span><span class="s3">()</span>
        <span class="s1">score</span><span class="s3">, </span><span class="s1">confidence</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">prediction_results </span><span class="s3">= </span><span class="s1">evaluate_combination</span><span class="s3">(</span><span class="s1">params</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">score </span><span class="s3">&gt;= </span><span class="s7">0 </span><span class="s2">and </span><span class="s1">prediction_results</span><span class="s3">:  </span><span class="s0"># 只保存有效的结果</span>
            <span class="s1">results</span><span class="s3">.</span><span class="s1">append</span><span class="s3">({</span>
                <span class="s4">'parameters'</span><span class="s3">: </span><span class="s1">params</span><span class="s3">,</span>
                <span class="s4">'score'</span><span class="s3">: </span><span class="s1">score</span><span class="s3">,</span>
                <span class="s4">'confidence'</span><span class="s3">: </span><span class="s1">confidence</span><span class="s3">,</span>
                <span class="s4">'component_scores'</span><span class="s3">: </span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'component_scores'</span><span class="s3">],</span>
                <span class="s4">'optimization_suggestions'</span><span class="s3">: </span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'optimization_suggestions'</span><span class="s3">]</span>
            <span class="s3">})</span>

    <span class="s0"># 按分数排序并返回最佳结果</span>
    <span class="s1">sorted_results </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">results</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">[</span><span class="s4">'score'</span><span class="s3">], </span><span class="s1">reverse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">top_results </span><span class="s3">= </span><span class="s1">sorted_results</span><span class="s3">[:</span><span class="s7">5</span><span class="s3">]  </span><span class="s0"># 返回前5个最佳组合</span>

    <span class="s0"># 分析最佳参数的共同特征</span>
    <span class="s1">param_analysis </span><span class="s3">= </span><span class="s1">analyze_best_parameters</span><span class="s3">(</span><span class="s1">top_results</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">top_results</span><span class="s3">, </span><span class="s1">param_analysis</span>


<span class="s2">def </span><span class="s1">analyze_best_parameters</span><span class="s3">(</span><span class="s1">top_results</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">Dict</span><span class="s3">]) </span><span class="s1">-&gt; Dict</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;分析最佳参数组合的共同特征&quot;&quot;&quot;</span>
    <span class="s1">param_ranges </span><span class="s3">= {</span><span class="s1">param</span><span class="s3">: [] </span><span class="s2">for </span><span class="s1">param </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">}</span>

    <span class="s0"># 收集所有参数值</span>
    <span class="s2">for </span><span class="s1">result </span><span class="s2">in </span><span class="s1">top_results</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">param</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">result</span><span class="s3">[</span><span class="s4">'parameters'</span><span class="s3">].</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">param_ranges</span><span class="s3">[</span><span class="s1">param</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>

    <span class="s0"># 计算每个参数的统计信息</span>
    <span class="s1">analysis </span><span class="s3">= {}</span>
    <span class="s2">for </span><span class="s1">param</span><span class="s3">, </span><span class="s1">values </span><span class="s2">in </span><span class="s1">param_ranges</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s1">analysis</span><span class="s3">[</span><span class="s1">param</span><span class="s3">] = {</span>
            <span class="s4">'mean'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">values</span><span class="s3">),</span>
            <span class="s4">'std'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">values</span><span class="s3">),</span>
            <span class="s4">'min'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">values</span><span class="s3">),</span>
            <span class="s4">'max'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">values</span><span class="s3">)</span>
        <span class="s3">}</span>

        <span class="s0"># 添加参数趋势分析</span>
        <span class="s1">mean_value </span><span class="s3">= </span><span class="s1">analysis</span><span class="s3">[</span><span class="s1">param</span><span class="s3">][</span><span class="s4">'mean'</span><span class="s3">]</span>
        <span class="s1">param_range </span><span class="s3">= </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">param</span><span class="s3">]</span>
        <span class="s1">range_center </span><span class="s3">= (</span><span class="s1">param_range</span><span class="s3">[</span><span class="s7">0</span><span class="s3">] + </span><span class="s1">param_range</span><span class="s3">[</span><span class="s7">1</span><span class="s3">]) / </span><span class="s7">2</span>

        <span class="s2">if </span><span class="s1">mean_value </span><span class="s3">&gt; </span><span class="s1">range_center </span><span class="s3">+ </span><span class="s1">param_range</span><span class="s3">[</span><span class="s7">2</span><span class="s3">]:</span>
            <span class="s1">analysis</span><span class="s3">[</span><span class="s1">param</span><span class="s3">][</span><span class="s4">'trend'</span><span class="s3">] = </span><span class="s4">&quot;偏高&quot;</span>
        <span class="s2">elif </span><span class="s1">mean_value </span><span class="s3">&lt; </span><span class="s1">range_center </span><span class="s3">- </span><span class="s1">param_range</span><span class="s3">[</span><span class="s7">2</span><span class="s3">]:</span>
            <span class="s1">analysis</span><span class="s3">[</span><span class="s1">param</span><span class="s3">][</span><span class="s4">'trend'</span><span class="s3">] = </span><span class="s4">&quot;偏低&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">analysis</span><span class="s3">[</span><span class="s1">param</span><span class="s3">][</span><span class="s4">'trend'</span><span class="s3">] = </span><span class="s4">&quot;适中&quot;</span>

    <span class="s2">return </span><span class="s1">analysis</span>


<span class="s2">def </span><span class="s1">print_optimal_parameters</span><span class="s3">(</span><span class="s1">optimal_results</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">Dict</span><span class="s3">], </span><span class="s1">param_analysis</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;打印最佳参数组合和分析结果&quot;&quot;&quot;</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 推荐的最佳打印参数 ===&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">注意：以下参数仅供参考，请结合实际情况调整&quot;</span><span class="s3">)</span>

    <span class="s0"># 打印每组最佳参数</span>
    <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">result </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">optimal_results</span><span class="s3">, </span><span class="s7">1</span><span class="s3">):</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">第 </span><span class="s6">{</span><span class="s1">i</span><span class="s6">} </span><span class="s4">组推荐参数 (预期质量分数: </span><span class="s6">{</span><span class="s1">result</span><span class="s3">[</span><span class="s4">'score'</span><span class="s3">]</span><span class="s6">:</span><span class="s4">.2f</span><span class="s6">}</span><span class="s4">, 预测可信度: </span><span class="s6">{</span><span class="s1">result</span><span class="s3">[</span><span class="s4">'confidence'</span><span class="s3">]</span><span class="s6">}</span><span class="s4">)&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;参数设置:&quot;</span><span class="s3">)</span>
        <span class="s1">params </span><span class="s3">= </span><span class="s1">result</span><span class="s3">[</span><span class="s4">'parameters'</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">param </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">:</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">params</span><span class="s3">[</span><span class="s1">param</span><span class="s3">]</span>

            <span class="s0"># 根据参数类型调整显示格式</span>
            <span class="s2">if </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'print_mode'</span><span class="s3">:</span>
                <span class="s1">formatted_value </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">get_print_mode_name</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">value</span><span class="s3">))</span><span class="s6">}</span><span class="s4">&quot;</span>
            <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'bottom_layers'</span><span class="s3">:</span>
                <span class="s1">formatted_value </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">int</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span><span class="s6">:</span><span class="s4">d</span><span class="s6">}</span><span class="s4">&quot;</span>
            <span class="s2">elif </span><span class="s1">param </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'layer_height'</span><span class="s3">, </span><span class="s4">'lifting_speed'</span><span class="s3">, </span><span class="s4">'liquid_speed'</span><span class="s3">, </span><span class="s4">'exposure_wait'</span><span class="s3">]:</span>
                <span class="s1">formatted_value </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">value</span><span class="s6">:</span><span class="s4">.3f</span><span class="s6">}</span><span class="s4">&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">formatted_value </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">value</span><span class="s6">:</span><span class="s4">.2f</span><span class="s6">}</span><span class="s4">&quot;</span>

            <span class="s1">unit </span><span class="s3">= </span><span class="s1">get_parameter_unit</span><span class="s3">(</span><span class="s1">param</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;  </span><span class="s6">{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">: </span><span class="s6">{</span><span class="s1">formatted_value</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">质量评分详情:&quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">comp</span><span class="s3">, </span><span class="s1">score </span><span class="s2">in </span><span class="s1">result</span><span class="s3">[</span><span class="s4">'component_scores'</span><span class="s3">].</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;  </span><span class="s6">{</span><span class="s1">comp</span><span class="s6">}</span><span class="s4">: </span><span class="s6">{</span><span class="s1">score</span><span class="s6">:</span><span class="s4">.2f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">result</span><span class="s3">[</span><span class="s4">'optimization_suggestions'</span><span class="s3">]:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">优化建议:&quot;</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">suggestion </span><span class="s2">in </span><span class="s1">result</span><span class="s3">[</span><span class="s4">'optimization_suggestions'</span><span class="s3">]:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;  - </span><span class="s6">{</span><span class="s1">suggestion</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s0"># 打印参数分析结果</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 最佳参数分析 ===&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;参数趋势分析:&quot;</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">param</span><span class="s3">, </span><span class="s1">analysis </span><span class="s2">in </span><span class="s1">param_analysis</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s1">unit </span><span class="s3">= </span><span class="s1">get_parameter_unit</span><span class="s3">(</span><span class="s1">param</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'print_mode'</span><span class="s3">:</span>
            <span class="s2">continue  </span><span class="s0"># 跳过打印模式的统计分析</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">:&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;  均值: </span><span class="s6">{</span><span class="s1">analysis</span><span class="s3">[</span><span class="s4">'mean'</span><span class="s3">]</span><span class="s6">:</span><span class="s4">.3f</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;  标准差: </span><span class="s6">{</span><span class="s1">analysis</span><span class="s3">[</span><span class="s4">'std'</span><span class="s3">]</span><span class="s6">:</span><span class="s4">.3f</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;  范围: </span><span class="s6">{</span><span class="s1">analysis</span><span class="s3">[</span><span class="s4">'min'</span><span class="s3">]</span><span class="s6">:</span><span class="s4">.3f</span><span class="s6">} </span><span class="s4">- </span><span class="s6">{</span><span class="s1">analysis</span><span class="s3">[</span><span class="s4">'max'</span><span class="s3">]</span><span class="s6">:</span><span class="s4">.3f</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;  趋势: </span><span class="s6">{</span><span class="s1">analysis</span><span class="s3">[</span><span class="s4">'trend'</span><span class="s3">]</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">run_prediction_loop</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">device</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;运行预测循环&quot;&quot;&quot;</span>
    <span class="s2">while True</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">params </span><span class="s3">= </span><span class="s1">input_params</span><span class="s3">()</span>
            <span class="s1">prediction_results </span><span class="s3">= </span><span class="s1">predict_quality</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">device</span><span class="s3">)</span>

            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">=== 预测结果 ===&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;时间: </span><span class="s6">{</span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'timestamp'</span><span class="s3">]</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">总体质量分数: </span><span class="s6">{</span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'overall_score'</span><span class="s3">]</span><span class="s6">:</span><span class="s4">.2f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;预测可信度: </span><span class="s6">{</span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'prediction_confidence'</span><span class="s3">]</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">打印模式提示:&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'print_mode_tip'</span><span class="s3">])</span>

            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">各组件分数:&quot;</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">component</span><span class="s3">, </span><span class="s1">score </span><span class="s2">in </span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'component_scores'</span><span class="s3">].</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s1">confidence </span><span class="s3">= </span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'component_confidence'</span><span class="s3">][</span><span class="s1">component</span><span class="s3">]</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">component</span><span class="s6">}</span><span class="s4">: </span><span class="s6">{</span><span class="s1">score</span><span class="s6">:</span><span class="s4">.2f</span><span class="s6">} </span><span class="s4">(可信度: </span><span class="s6">{</span><span class="s1">confidence</span><span class="s6">}</span><span class="s4">)&quot;</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'optimization_suggestions'</span><span class="s3">]:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">优化建议:&quot;</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">suggestion </span><span class="s2">in </span><span class="s1">prediction_results</span><span class="s3">[</span><span class="s4">'optimization_suggestions'</span><span class="s3">]:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;- </span><span class="s6">{</span><span class="s1">suggestion</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">是否要:&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;1. 继续预测&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;2. 保存该组参数&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;3. 返回主菜单&quot;</span><span class="s3">)</span>

            <span class="s1">choice </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请选择 [1/2/3]: &quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;2&quot;</span><span class="s3">:</span>
                <span class="s0"># 保存参数到文件</span>
                <span class="s1">timestamp </span><span class="s3">= </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">now</span><span class="s3">().</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">&quot;%Y%m%d_%H%M%S&quot;</span><span class="s3">)</span>
                <span class="s1">filename </span><span class="s3">= </span><span class="s4">f'quality_prediction_</span><span class="s6">{</span><span class="s1">timestamp</span><span class="s6">}</span><span class="s4">.json'</span>
                <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf-8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                    <span class="s1">json</span><span class="s3">.</span><span class="s1">dump</span><span class="s3">({</span>
                        <span class="s4">'parameters'</span><span class="s3">: </span><span class="s1">params</span><span class="s3">,</span>
                        <span class="s4">'prediction_results'</span><span class="s3">: </span><span class="s1">prediction_results</span>
                    <span class="s3">}, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">=</span><span class="s7">4</span><span class="s3">, </span><span class="s1">ensure_ascii</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">结果已保存至: </span><span class="s6">{</span><span class="s1">filename</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;3&quot;</span><span class="s3">:</span>
                <span class="s2">break</span>

        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;预测过程中出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">预测过程中出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">retry </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;是否重试？(y/n) [y]: &quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">retry</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s4">'n'</span><span class="s3">:</span>
                <span class="s2">break</span>


<span class="s2">def </span><span class="s1">load_latest_model</span><span class="s3">(</span><span class="s1">device</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;加载最新的模型文件&quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s0"># 获取最新的模型文件</span>
        <span class="s1">model_files </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">() </span><span class="s2">if </span><span class="s1">f</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'microneedle_quality_model_'</span><span class="s3">)],</span>
            <span class="s1">reverse</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">model_files</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">FileNotFoundError</span><span class="s3">(</span><span class="s4">&quot;未找到模型文件&quot;</span><span class="s3">)</span>

        <span class="s1">model_file </span><span class="s3">= </span><span class="s1">model_files</span><span class="s3">[</span><span class="s7">0</span><span class="s3">]</span>
        <span class="s1">info_file </span><span class="s3">= </span><span class="s1">model_file</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'model_'</span><span class="s3">, </span><span class="s4">'info_'</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'.pth'</span><span class="s3">, </span><span class="s4">'.json'</span><span class="s3">)</span>

        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;加载模型: </span><span class="s6">{</span><span class="s1">model_file</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;加载模型信息: </span><span class="s6">{</span><span class="s1">info_file</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">info_file</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf-8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">model_info </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>

        <span class="s1">model </span><span class="s3">= </span><span class="s1">MicroneedleQualityModel</span><span class="s3">(</span>
            <span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">),</span>
            <span class="s1">len</span><span class="s3">(</span><span class="s1">quality_score_components</span><span class="s3">),</span>
            <span class="s1">model_info</span><span class="s3">[</span><span class="s4">'hyperparameters'</span><span class="s3">][</span><span class="s4">'layer_sizes'</span><span class="s3">]</span>
        <span class="s3">)</span>

        <span class="s1">model</span><span class="s3">.</span><span class="s1">load_state_dict</span><span class="s3">(</span><span class="s1">torch</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">model_file</span><span class="s3">, </span><span class="s1">map_location</span><span class="s3">=</span><span class="s1">device</span><span class="s3">))</span>
        <span class="s1">model </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">to</span><span class="s3">(</span><span class="s1">device</span><span class="s3">)</span>
        <span class="s1">model</span><span class="s3">.</span><span class="s1">eval</span><span class="s3">()</span>

        <span class="s2">return </span><span class="s1">model</span><span class="s3">, </span><span class="s1">model_info</span>

    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;加载模型失败: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">raise</span>


<span class="s2">def </span><span class="s1">main</span><span class="s3">():</span>
    <span class="s5">&quot;&quot;&quot;主程序入口&quot;&quot;&quot;</span>
    <span class="s2">while True</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 微针质量预测系统 ===&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;1. 训练新模型&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;2. 使用现有模型进行预测&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;3. 搜索最佳打印参数&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;4. 生成合成数据集&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;5. 查看参数说明&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;6. 退出&quot;</span><span class="s3">)</span>

            <span class="s1">choice </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请选择操作 [1-6]: &quot;</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;1&quot;</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 训练新模型 ===&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;1. 使用现有数据文件&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;2. 生成新的合成数据&quot;</span><span class="s3">)</span>
                <span class="s1">data_choice </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请选择 [1/2]: &quot;</span><span class="s3">)</span>

                <span class="s2">if </span><span class="s1">data_choice </span><span class="s3">== </span><span class="s4">&quot;2&quot;</span><span class="s3">:</span>
                    <span class="s1">num_samples </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请输入要生成的样本数量 [1000]: &quot;</span><span class="s3">)</span>
                    <span class="s1">num_samples </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">) </span><span class="s2">if </span><span class="s1">num_samples</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s7">1000</span>
                    <span class="s1">train_data</span><span class="s3">, </span><span class="s1">val_data </span><span class="s3">= </span><span class="s1">generate_synthetic_data</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">加载训练数据...&quot;</span><span class="s3">)</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s1">data_files </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span>
                            <span class="s3">[</span><span class="s1">f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">() </span><span class="s2">if </span><span class="s1">f</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'train_data_'</span><span class="s3">)],</span>
                            <span class="s1">reverse</span><span class="s3">=</span><span class="s2">True</span>
                        <span class="s3">)</span>
                        <span class="s2">if not </span><span class="s1">data_files</span><span class="s3">:</span>
                            <span class="s2">raise </span><span class="s1">FileNotFoundError</span><span class="s3">(</span><span class="s4">&quot;未找到训练数据文件&quot;</span><span class="s3">)</span>

                        <span class="s1">train_file </span><span class="s3">= </span><span class="s1">data_files</span><span class="s3">[</span><span class="s7">0</span><span class="s3">]</span>
                        <span class="s1">val_file </span><span class="s3">= </span><span class="s1">train_file</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'train_data_'</span><span class="s3">, </span><span class="s4">'val_data_'</span><span class="s3">)</span>

                        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;加载训练数据: </span><span class="s6">{</span><span class="s1">train_file</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                        <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;加载验证数据: </span><span class="s6">{</span><span class="s1">val_file</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                        <span class="s1">train_data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">loadtxt</span><span class="s3">(</span><span class="s1">train_file</span><span class="s3">, </span><span class="s1">delimiter</span><span class="s3">=</span><span class="s4">','</span><span class="s3">, </span><span class="s1">skiprows</span><span class="s3">=</span><span class="s7">1</span><span class="s3">)</span>
                        <span class="s1">val_data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">loadtxt</span><span class="s3">(</span><span class="s1">val_file</span><span class="s3">, </span><span class="s1">delimiter</span><span class="s3">=</span><span class="s4">','</span><span class="s3">, </span><span class="s1">skiprows</span><span class="s3">=</span><span class="s7">1</span><span class="s3">)</span>
                    <span class="s2">except </span><span class="s1">FileNotFoundError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">错误：</span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">。请先生成数据。&quot;</span><span class="s3">)</span>
                        <span class="s2">continue</span>
                    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;加载数据时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">加载数据时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                        <span class="s2">continue</span>

                <span class="s1">X_train </span><span class="s3">= </span><span class="s1">train_data</span><span class="s3">[:, :</span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">)]</span>
                <span class="s1">y_train </span><span class="s3">= </span><span class="s1">train_data</span><span class="s3">[:, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">):]</span>
                <span class="s1">X_val </span><span class="s3">= </span><span class="s1">val_data</span><span class="s3">[:, :</span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">)]</span>
                <span class="s1">y_val </span><span class="s3">= </span><span class="s1">val_data</span><span class="s3">[:, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">):]</span>

                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;数据加载成功！&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;训练集样本数: </span><span class="s6">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;验证集样本数: </span><span class="s6">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X_val</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                <span class="s1">hyperparams </span><span class="s3">= </span><span class="s1">get_hyperparameters</span><span class="s3">()</span>

                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">开始训练模型...&quot;</span><span class="s3">)</span>
                <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cuda&quot; </span><span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">() </span><span class="s2">else </span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>
                <span class="s1">model</span><span class="s3">, </span><span class="s1">best_loss </span><span class="s3">= </span><span class="s1">train_model</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">, </span><span class="s1">y_train</span><span class="s3">, </span><span class="s1">X_val</span><span class="s3">, </span><span class="s1">y_val</span><span class="s3">, </span><span class="s1">hyperparams</span><span class="s3">)</span>

                <span class="s1">save_model</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">hyperparams</span><span class="s3">, </span><span class="s1">best_loss</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">模型训练完成！&quot;</span><span class="s3">)</span>

            <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;2&quot;</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cuda&quot; </span><span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">() </span><span class="s2">else </span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>
                    <span class="s1">model</span><span class="s3">, </span><span class="s1">model_info </span><span class="s3">= </span><span class="s1">load_latest_model</span><span class="s3">(</span><span class="s1">device</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;模型加载成功！&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;模型信息:&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;- 训练时间: </span><span class="s6">{</span><span class="s1">model_info</span><span class="s3">[</span><span class="s4">'timestamp'</span><span class="s3">]</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;- 最佳验证损失: </span><span class="s6">{</span><span class="s1">model_info</span><span class="s3">[</span><span class="s4">'best_validation_loss'</span><span class="s3">]</span><span class="s6">:</span><span class="s4">.4f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 参数范围参考 ===&quot;</span><span class="s3">)</span>
                    <span class="s2">for </span><span class="s1">param </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">:</span>
                        <span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">step </span><span class="s3">= </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">param</span><span class="s3">]</span>
                        <span class="s1">unit </span><span class="s3">= </span><span class="s1">get_parameter_unit</span><span class="s3">(</span><span class="s1">param</span><span class="s3">)</span>
                        <span class="s2">if </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'print_mode'</span><span class="s3">:</span>
                            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">: 0-连续打印, 1-间歇打印, 2-往复打印&quot;</span><span class="s3">)</span>
                        <span class="s2">else</span><span class="s3">:</span>
                            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">: </span><span class="s6">{</span><span class="s1">min_val</span><span class="s6">}</span><span class="s4">-</span><span class="s6">{</span><span class="s1">max_val</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">, 步长</span><span class="s6">{</span><span class="s1">step</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                    <span class="s1">run_prediction_loop</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">device</span><span class="s3">)</span>

                <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                    <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;预测模式出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">预测模式出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s2">continue</span>

            <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;3&quot;</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cuda&quot; </span><span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">() </span><span class="s2">else </span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>
                    <span class="s1">model</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">load_latest_model</span><span class="s3">(</span><span class="s1">device</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;模型加载成功！&quot;</span><span class="s3">)</span>

                    <span class="s0"># 设置搜索参数</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">搜索设置:&quot;</span><span class="s3">)</span>
                    <span class="s1">num_combinations </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请输入要测试的参数组合数量 [1000]: &quot;</span><span class="s3">)</span>
                    <span class="s1">num_combinations </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">num_combinations</span><span class="s3">) </span><span class="s2">if </span><span class="s1">num_combinations</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s7">1000</span>

                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">是否要设置参数约束？&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;1. 不设置约束&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;2. 设置参数范围约束&quot;</span><span class="s3">)</span>
                    <span class="s1">constraint_choice </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请选择 [1/2]: &quot;</span><span class="s3">)</span>

                    <span class="s1">constraints </span><span class="s3">= </span><span class="s2">None</span>
                    <span class="s2">if </span><span class="s1">constraint_choice </span><span class="s3">== </span><span class="s4">&quot;2&quot;</span><span class="s3">:</span>
                        <span class="s1">constraints </span><span class="s3">= {}</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请输入需要约束的参数范围（直接回车跳过该参数）:&quot;</span><span class="s3">)</span>
                        <span class="s2">for </span><span class="s1">param </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">:</span>
                            <span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">param</span><span class="s3">]</span>
                            <span class="s1">unit </span><span class="s3">= </span><span class="s1">get_parameter_unit</span><span class="s3">(</span><span class="s1">param</span><span class="s3">)</span>

                            <span class="s2">if </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'print_mode'</span><span class="s3">:</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">当前参数: </span><span class="s6">{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;0 - 连续打印&quot;</span><span class="s3">)</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;1 - 间歇打印&quot;</span><span class="s3">)</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;2 - 往复打印&quot;</span><span class="s3">)</span>
                                <span class="s1">mode_input </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请输入允许的打印模式（用逗号分隔）[0,1,2]: &quot;</span><span class="s3">)</span>
                                <span class="s2">if </span><span class="s1">mode_input</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">():</span>
                                    <span class="s1">allowed_modes </span><span class="s3">= [</span><span class="s1">int</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">mode_input</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">','</span><span class="s3">)]</span>
                                    <span class="s2">if </span><span class="s1">allowed_modes</span><span class="s3">:</span>
                                        <span class="s1">constraints</span><span class="s3">[</span><span class="s1">param</span><span class="s3">] = (</span><span class="s1">min</span><span class="s3">(</span><span class="s1">allowed_modes</span><span class="s3">), </span><span class="s1">max</span><span class="s3">(</span><span class="s1">allowed_modes</span><span class="s3">))</span>
                            <span class="s2">else</span><span class="s3">:</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">当前参数: </span><span class="s6">{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;默认范围: </span><span class="s6">{</span><span class="s1">min_val</span><span class="s6">}</span><span class="s4">-</span><span class="s6">{</span><span class="s1">max_val</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                                <span class="s1">min_input </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">f&quot;最小值 [</span><span class="s6">{</span><span class="s1">min_val</span><span class="s6">}</span><span class="s4">]: &quot;</span><span class="s3">)</span>
                                <span class="s1">max_input </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">f&quot;最大值 [</span><span class="s6">{</span><span class="s1">max_val</span><span class="s6">}</span><span class="s4">]: &quot;</span><span class="s3">)</span>

                                <span class="s2">if </span><span class="s1">min_input</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">or </span><span class="s1">max_input</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">():</span>
                                    <span class="s1">min_value </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">min_input</span><span class="s3">) </span><span class="s2">if </span><span class="s1">min_input</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s1">min_val</span>
                                    <span class="s1">max_value </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">max_input</span><span class="s3">) </span><span class="s2">if </span><span class="s1">max_input</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s1">max_val</span>
                                    <span class="s1">constraints</span><span class="s3">[</span><span class="s1">param</span><span class="s3">] = (</span><span class="s1">min_value</span><span class="s3">, </span><span class="s1">max_value</span><span class="s3">)</span>

                    <span class="s0"># 搜索最佳参数</span>
                    <span class="s1">optimal_results</span><span class="s3">, </span><span class="s1">param_analysis </span><span class="s3">= </span><span class="s1">find_optimal_parameters</span><span class="s3">(</span>
                        <span class="s1">model</span><span class="s3">,</span>
                        <span class="s1">num_combinations</span><span class="s3">=</span><span class="s1">num_combinations</span><span class="s3">,</span>
                        <span class="s1">constraints</span><span class="s3">=</span><span class="s1">constraints</span>
                    <span class="s3">)</span>

                    <span class="s0"># 打印结果</span>
                    <span class="s1">print_optimal_parameters</span><span class="s3">(</span><span class="s1">optimal_results</span><span class="s3">, </span><span class="s1">param_analysis</span><span class="s3">)</span>

                    <span class="s0"># 保存结果</span>
                    <span class="s1">timestamp </span><span class="s3">= </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">now</span><span class="s3">().</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">&quot;%Y%m%d_%H%M%S&quot;</span><span class="s3">)</span>
                    <span class="s1">filename </span><span class="s3">= </span><span class="s4">f'optimal_parameters_</span><span class="s6">{</span><span class="s1">timestamp</span><span class="s6">}</span><span class="s4">.json'</span>
                    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf-8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                        <span class="s1">json</span><span class="s3">.</span><span class="s1">dump</span><span class="s3">({</span>
                            <span class="s4">'optimal_results'</span><span class="s3">: </span><span class="s1">optimal_results</span><span class="s3">,</span>
                            <span class="s4">'param_analysis'</span><span class="s3">: </span><span class="s1">param_analysis</span><span class="s3">,</span>
                            <span class="s4">'constraints'</span><span class="s3">: </span><span class="s1">constraints</span><span class="s3">,</span>
                            <span class="s4">'search_settings'</span><span class="s3">: {</span>
                                <span class="s4">'num_combinations'</span><span class="s3">: </span><span class="s1">num_combinations</span>
                            <span class="s3">}</span>
                        <span class="s3">}, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">=</span><span class="s7">4</span><span class="s3">, </span><span class="s1">ensure_ascii</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">结果已保存至: </span><span class="s6">{</span><span class="s1">filename</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                    <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;参数优化过程出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">参数优化过程出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s2">continue</span>

            <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;4&quot;</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 生成合成数据 ===&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;此功能将生成用于模型训练的模拟数据&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;数据生成基于预设的参数范围和质量影响规则&quot;</span><span class="s3">)</span>

                    <span class="s1">num_samples </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请输入要生成的样本数量 [1000]: &quot;</span><span class="s3">)</span>
                    <span class="s1">num_samples </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">) </span><span class="s2">if </span><span class="s1">num_samples</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s7">1000</span>

                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">生成数据设置:&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;1. 均匀分布采样&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;2. 聚焦于最佳参数区域采样&quot;</span><span class="s3">)</span>
                    <span class="s1">sampling_choice </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请选择采样方式 [1/2]: &quot;</span><span class="s3">)</span>

                    <span class="s2">if </span><span class="s1">sampling_choice </span><span class="s3">== </span><span class="s4">&quot;2&quot;</span><span class="s3">:</span>
                        <span class="s2">try</span><span class="s3">:</span>
                            <span class="s0"># 读取最近的优化结果</span>
                            <span class="s1">optimal_files </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span>
                                <span class="s3">[</span><span class="s1">f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">() </span><span class="s2">if </span><span class="s1">f</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'optimal_parameters_'</span><span class="s3">)],</span>
                                <span class="s1">reverse</span><span class="s3">=</span><span class="s2">True</span>
                            <span class="s3">)</span>
                            <span class="s2">if </span><span class="s1">optimal_files</span><span class="s3">:</span>
                                <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">optimal_files</span><span class="s3">[</span><span class="s7">0</span><span class="s3">], </span><span class="s4">'r'</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf-8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                                    <span class="s1">optimal_data </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
                                <span class="s1">param_analysis </span><span class="s3">= </span><span class="s1">optimal_data</span><span class="s3">[</span><span class="s4">'param_analysis'</span><span class="s3">]</span>

                                <span class="s0"># 调整参数范围以聚焦于最佳区域</span>
                                <span class="s1">temp_ranges </span><span class="s3">= </span><span class="s1">PARAM_RANGES</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
                                <span class="s2">for </span><span class="s1">param</span><span class="s3">, </span><span class="s1">analysis </span><span class="s2">in </span><span class="s1">param_analysis</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                                    <span class="s2">if </span><span class="s1">param </span><span class="s3">!= </span><span class="s4">'print_mode'</span><span class="s3">:</span>
                                        <span class="s1">mean </span><span class="s3">= </span><span class="s1">analysis</span><span class="s3">[</span><span class="s4">'mean'</span><span class="s3">]</span>
                                        <span class="s1">std </span><span class="s3">= </span><span class="s1">analysis</span><span class="s3">[</span><span class="s4">'std'</span><span class="s3">]</span>
                                        <span class="s1">temp_ranges</span><span class="s3">[</span><span class="s1">param</span><span class="s3">] = (</span>
                                            <span class="s1">max</span><span class="s3">(</span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">param</span><span class="s3">][</span><span class="s7">0</span><span class="s3">], </span><span class="s1">mean </span><span class="s3">- </span><span class="s7">2 </span><span class="s3">* </span><span class="s1">std</span><span class="s3">),</span>
                                            <span class="s1">min</span><span class="s3">(</span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">param</span><span class="s3">][</span><span class="s7">1</span><span class="s3">], </span><span class="s1">mean </span><span class="s3">+ </span><span class="s7">2 </span><span class="s3">* </span><span class="s1">std</span><span class="s3">),</span>
                                            <span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">param</span><span class="s3">][</span><span class="s7">2</span><span class="s3">]</span>
                                        <span class="s3">)</span>

                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">使用优化后的参数范围生成数据...&quot;</span><span class="s3">)</span>
                                <span class="s1">generate_synthetic_data</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">, </span><span class="s1">param_ranges</span><span class="s3">=</span><span class="s1">temp_ranges</span><span class="s3">)</span>
                            <span class="s2">else</span><span class="s3">:</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">未找到优化结果，使用默认参数范围...&quot;</span><span class="s3">)</span>
                                <span class="s1">generate_synthetic_data</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">)</span>
                        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;读取优化结果失败: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">读取优化结果失败，使用默认参数范围...&quot;</span><span class="s3">)</span>
                            <span class="s1">generate_synthetic_data</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">generate_synthetic_data</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">)</span>

                <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">生成数据时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s2">continue</span>
                <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                    <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;生成数据时出现意外错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">生成数据时出现意外错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s2">continue</span>

            <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;5&quot;</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 参数说明 ===&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">打印参数说明:&quot;</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">param </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">:</span>
                    <span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">step </span><span class="s3">= </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">param</span><span class="s3">]</span>
                    <span class="s1">unit </span><span class="s3">= </span><span class="s1">get_parameter_unit</span><span class="s3">(</span><span class="s1">param</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">:&quot;</span><span class="s3">)</span>

                    <span class="s2">if </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'layer_height'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 每层打印的厚度&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 影响: 直接影响打印精度和打印时间&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: 精细结构选择较小值，粗糙结构可选择较大值&quot;</span><span class="s3">)</span>

                    <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'exposure_time'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 每层光固化的时间&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 影响: 影响材料固化程度和打印速度&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: 根据材料特性和层厚调整&quot;</span><span class="s3">)</span>

                    <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'exposure_intensity'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 光源的输出强度&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 影响: 影响固化效果和打印质量&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: 需要与曝光时间配合调整&quot;</span><span class="s3">)</span>

                    <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'bottom_layers'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 底部基础层的数量&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 影响: 影响模型与基板的粘附强度&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: 根据模型重量和尺寸选择&quot;</span><span class="s3">)</span>

                    <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'bottom_exposure_intensity'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 底层的曝光强度&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 影响: 影响模型与基板的粘附强度&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: 通常高于普通层的曝光强度&quot;</span><span class="s3">)</span>

                    <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'lifting_speed'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 打印平台抬升的速度&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 影响: 影响层间分离效果和打印时间&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: 根据材料粘度调整&quot;</span><span class="s3">)</span>

                    <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'exposure_wait'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 曝光前的等待时间&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 影响: 影响材料稳定性和均匀性&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: 根据材料流动性调整&quot;</span><span class="s3">)</span>

                    <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'liquid_speed'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 树脂流动填充速度&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 影响: 影响层间材料填充均匀性&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: 根据材料粘度和模型结构调整&quot;</span><span class="s3">)</span>

                    <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'bottom_exposure_time'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 底层的曝光时间&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 影响: 影响底层固化程度和基板附着力&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: 通常是普通层曝光时间的2-3倍&quot;</span><span class="s3">)</span>

                    <span class="s2">elif </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'print_mode'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 描述: 打印模式选择&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 选项: 0-连续打印, 1-间歇打印, 2-往复打印&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;- 建议: &quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;  * 连续打印: 适合简单结构，打印速度快&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;  * 间歇打印: 适合精细结构，层间结合好&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;  * 往复打印: 适合特殊结构，需要特别调整&quot;</span><span class="s3">)</span>

                    <span class="s2">if </span><span class="s1">param </span><span class="s3">!= </span><span class="s4">'print_mode'</span><span class="s3">:</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;- 取值范围: </span><span class="s6">{</span><span class="s1">min_val</span><span class="s6">}</span><span class="s4">-</span><span class="s6">{</span><span class="s1">max_val</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;- 调整步长: </span><span class="s6">{</span><span class="s1">step</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                <span class="s1">input</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">按回车键继续...&quot;</span><span class="s3">)</span>

            <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;6&quot;</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">感谢使用！再见！&quot;</span><span class="s3">)</span>
                <span class="s2">break</span>

            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">无效的选择，请重试。&quot;</span><span class="s3">)</span>

        <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;输入错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">输入错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">retry </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;是否继续？(y/n) [y]: &quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">retry</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s4">'n'</span><span class="s3">:</span>
                <span class="s2">break</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;发生意外错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">发生意外错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">retry </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;是否继续？(y/n) [y]: &quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">retry</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s4">'n'</span><span class="s3">:</span>
                <span class="s2">break</span>

<span class="s2">def </span><span class="s1">ensure_data_structure</span><span class="s3">():</span>
    <span class="s5">&quot;&quot;&quot;确保数据目录结构正确&quot;&quot;&quot;</span>
    <span class="s1">directories </span><span class="s3">= [</span><span class="s4">'data'</span><span class="s3">, </span><span class="s4">'models'</span><span class="s3">, </span><span class="s4">'logs'</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">dir_name </span><span class="s2">in </span><span class="s1">directories</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">dir_name</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">dir_name</span><span class="s3">)</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;创建目录: </span><span class="s6">{</span><span class="s1">dir_name</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s4">'__main__'</span><span class="s3">:</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 微针质量预测系统 ===&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;版本: 4.1.0&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;作者: CombjellyShen&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;日期: 2024-11-26&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;=&quot; </span><span class="s3">* </span><span class="s7">30</span><span class="s3">)</span>

        <span class="s0"># 1. 检查依赖</span>
        <span class="s1">check_dependencies</span><span class="s3">()</span>
        <span class="s1">ensure_data_structure</span><span class="s3">()</span>

        <span class="s0"># 2. 打印系统信息</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 系统信息 ===&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;操作系统: </span><span class="s6">{</span><span class="s1">platform</span><span class="s3">.</span><span class="s1">system</span><span class="s3">()</span><span class="s6">} {</span><span class="s1">platform</span><span class="s3">.</span><span class="s1">version</span><span class="s3">()</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;Python版本: </span><span class="s6">{</span><span class="s1">platform</span><span class="s3">.</span><span class="s1">python_version</span><span class="s3">()</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;CPU型号: </span><span class="s6">{</span><span class="s1">platform</span><span class="s3">.</span><span class="s1">processor</span><span class="s3">()</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;CPU核心数: </span><span class="s6">{</span><span class="s1">multiprocessing</span><span class="s3">.</span><span class="s1">cpu_count</span><span class="s3">()</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">():</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">GPU信息:&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;设备名称: </span><span class="s6">{</span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">get_device_name</span><span class="s3">(</span><span class="s7">0</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;CUDA版本: </span><span class="s6">{</span><span class="s1">torch</span><span class="s3">.</span><span class="s1">version</span><span class="s3">.</span><span class="s1">cuda</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">CPU模式运行&quot;</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span><span class="s4">f&quot;获取系统信息时出现警告: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s0"># 3. 检查数据目录</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s4">'data'</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s4">'data'</span><span class="s3">)</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;创建数据目录: data&quot;</span><span class="s3">)</span>

        <span class="s0"># 4. 开始主程序循环</span>
        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 主菜单 ===&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;1. 训练新模型&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;2. 使用现有模型进行预测&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;3. 搜索最佳打印参数&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;4. 生成合成数据集&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;5. 查看参数说明&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;6. 退出&quot;</span><span class="s3">)</span>

                <span class="s1">choice </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请选择操作 [1-6]: &quot;</span><span class="s3">)</span>

                <span class="s2">if </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;1&quot;</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 训练新模型 ===&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;1. 使用现有数据文件&quot;</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;2. 生成新的合成数据&quot;</span><span class="s3">)</span>
                    <span class="s1">data_choice </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请选择 [1/2]: &quot;</span><span class="s3">)</span>

                    <span class="s2">if </span><span class="s1">data_choice </span><span class="s3">== </span><span class="s4">&quot;2&quot;</span><span class="s3">:</span>
                        <span class="s1">num_samples </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请输入要生成的样本数量 [1000]: &quot;</span><span class="s3">)</span>
                        <span class="s1">num_samples </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">) </span><span class="s2">if </span><span class="s1">num_samples</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s7">1000</span>
                        <span class="s1">generate_synthetic_data</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">)</span>
                    <span class="s2">elif </span><span class="s1">data_choice </span><span class="s3">== </span><span class="s4">&quot;1&quot;</span><span class="s3">:</span>
                        <span class="s2">try</span><span class="s3">:</span>
                        <span class="s0"># 检查现有数据文件</span>
                            <span class="s1">data_files </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">([</span><span class="s1">f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s4">'data'</span><span class="s3">) </span><span class="s2">if </span><span class="s1">f</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'train_data_'</span><span class="s3">)])</span>
                            <span class="s2">if not </span><span class="s1">data_files</span><span class="s3">:</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">错误: 未找到训练数据文件，请先生成数据。&quot;</span><span class="s3">)</span>
                                <span class="s2">continue</span>

                            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">找到以下数据文件:&quot;</span><span class="s3">)</span>
                            <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">f </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">data_files</span><span class="s3">, </span><span class="s7">1</span><span class="s3">):</span>
                                <span class="s1">file_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">'data'</span><span class="s3">, </span><span class="s1">f</span><span class="s3">)</span>
                                <span class="s1">file_size </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">getsize</span><span class="s3">(</span><span class="s1">file_path</span><span class="s3">) / </span><span class="s7">1024  </span><span class="s0"># 转换为KB</span>
                                <span class="s1">timestamp </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'_'</span><span class="s3">)[-</span><span class="s7">1</span><span class="s3">].</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'.csv'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>
                                <span class="s0"># 尝试读取文件的样本数量</span>
                                <span class="s2">try</span><span class="s3">:</span>
                                    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">file_path</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">file</span><span class="s3">:</span>
                                        <span class="s1">num_lines </span><span class="s3">= </span><span class="s1">sum</span><span class="s3">(</span><span class="s7">1 </span><span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">file</span><span class="s3">) - </span><span class="s7">1  </span><span class="s0"># 减去头行</span>
                                <span class="s2">except</span><span class="s3">:</span>
                                    <span class="s1">num_lines </span><span class="s3">= </span><span class="s4">&quot;未知&quot;</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">i</span><span class="s6">}</span><span class="s4">. </span><span class="s6">{</span><span class="s1">f</span><span class="s6">} </span><span class="s4">(大小: </span><span class="s6">{</span><span class="s1">file_size</span><span class="s6">:</span><span class="s4">.1f</span><span class="s6">}</span><span class="s4">KB, 样本数: </span><span class="s6">{</span><span class="s1">num_lines</span><span class="s6">}</span><span class="s4">)&quot;</span><span class="s3">)</span>

                            <span class="s1">file_choice </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请选择要使用的数据文件 [1-{}]: &quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">data_files</span><span class="s3">)))</span>
                            <span class="s2">try</span><span class="s3">:</span>
                                <span class="s1">file_index </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">file_choice</span><span class="s3">) - </span><span class="s7">1</span>
                                <span class="s2">if </span><span class="s7">0 </span><span class="s3">&lt;= </span><span class="s1">file_index </span><span class="s3">&lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">data_files</span><span class="s3">):</span>
                                    <span class="s1">selected_train_file </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">'data'</span><span class="s3">, </span><span class="s1">data_files</span><span class="s3">[</span><span class="s1">file_index</span><span class="s3">])</span>
                                    <span class="s1">selected_val_file </span><span class="s3">= </span><span class="s1">selected_train_file</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'train_data_'</span><span class="s3">, </span><span class="s4">'val_data_'</span><span class="s3">)</span>

                                    <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">selected_val_file</span><span class="s3">):</span>
                                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">错误: 未找到对应的验证数据文件: </span><span class="s6">{</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">selected_val_file</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                                        <span class="s2">continue</span>

                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">加载数据文件...&quot;</span><span class="s3">)</span>
                                    <span class="s1">train_data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">loadtxt</span><span class="s3">(</span><span class="s1">selected_train_file</span><span class="s3">, </span><span class="s1">delimiter</span><span class="s3">=</span><span class="s4">','</span><span class="s3">, </span><span class="s1">skiprows</span><span class="s3">=</span><span class="s7">1</span><span class="s3">)</span>
                                    <span class="s1">val_data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">loadtxt</span><span class="s3">(</span><span class="s1">selected_val_file</span><span class="s3">, </span><span class="s1">delimiter</span><span class="s3">=</span><span class="s4">','</span><span class="s3">, </span><span class="s1">skiprows</span><span class="s3">=</span><span class="s7">1</span><span class="s3">)</span>

                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;数据加载成功!&quot;</span><span class="s3">)</span>
                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;训练集样本数: </span><span class="s6">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">train_data</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;验证集样本数: </span><span class="s6">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">val_data</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                                    <span class="s0"># 分离特征和标签</span>
                                    <span class="s1">X_train </span><span class="s3">= </span><span class="s1">train_data</span><span class="s3">[:, :</span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">)]</span>
                                    <span class="s1">y_train </span><span class="s3">= </span><span class="s1">train_data</span><span class="s3">[:, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">):]</span>
                                    <span class="s1">X_val </span><span class="s3">= </span><span class="s1">val_data</span><span class="s3">[:, :</span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">)]</span>
                                    <span class="s1">y_val </span><span class="s3">= </span><span class="s1">val_data</span><span class="s3">[:, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">):]</span>

                                    <span class="s0"># 获取超参数并训练模型</span>
                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">准备开始模型训练...&quot;</span><span class="s3">)</span>
                                    <span class="s1">hyperparams </span><span class="s3">= </span><span class="s1">get_hyperparameters</span><span class="s3">()</span>

                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">开始训练模型...&quot;</span><span class="s3">)</span>
                                    <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cuda&quot; </span><span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">() </span><span class="s2">else </span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>
                                    <span class="s1">model</span><span class="s3">, </span><span class="s1">best_loss </span><span class="s3">= </span><span class="s1">train_model</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">, </span><span class="s1">y_train</span><span class="s3">, </span><span class="s1">X_val</span><span class="s3">, </span><span class="s1">y_val</span><span class="s3">, </span><span class="s1">hyperparams</span><span class="s3">)</span>

                                    <span class="s0"># 保存模型</span>
                                    <span class="s1">save_model</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">hyperparams</span><span class="s3">, </span><span class="s1">best_loss</span><span class="s3">)</span>
                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">模型训练完成！&quot;</span><span class="s3">)</span>

                                <span class="s2">else</span><span class="s3">:</span>
                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">无效的选择！&quot;</span><span class="s3">)</span>
                                    <span class="s2">continue</span>
                            <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请输入有效的数字！&quot;</span><span class="s3">)</span>
                                <span class="s2">continue</span>

                        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;处理数据文件时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">处理数据文件时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                            <span class="s2">continue</span>



                <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;2&quot;</span><span class="s3">:</span>

                    <span class="s2">try</span><span class="s3">:</span>

                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 使用模型预测 ===&quot;</span><span class="s3">)</span>

                        <span class="s0"># 检查models目录</span>

                        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">):</span>
                            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">错误: 未找到模型目录，请先训练模型（选项1）。&quot;</span><span class="s3">)</span>

                            <span class="s2">continue</span>

                        <span class="s0"># 检查模型文件</span>

                        <span class="s1">model_files </span><span class="s3">= []</span>

                        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">):</span>

                            <span class="s0"># 只查找pth文件</span>

                            <span class="s2">if </span><span class="s1">f</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.pth'</span><span class="s3">):</span>

                                <span class="s1">info_file </span><span class="s3">= </span><span class="s1">f</span><span class="s3">[:-</span><span class="s7">4</span><span class="s3">] + </span><span class="s4">'_info.json'  </span><span class="s0"># 移除.pth后缀并添加_info.json</span>

                                <span class="s1">info_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">, </span><span class="s1">info_file</span><span class="s3">)</span>

                                <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">info_path</span><span class="s3">):</span>
                                    <span class="s1">model_files</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">f</span><span class="s3">, </span><span class="s1">info_file</span><span class="s3">))</span>

                        <span class="s2">if not </span><span class="s1">model_files</span><span class="s3">:</span>
                            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">错误: 未找到已训练的模型文件，请先训练模型（选项1）。&quot;</span><span class="s3">)</span>

                            <span class="s2">continue</span>

                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">找到以下模型文件:&quot;</span><span class="s3">)</span>

                        <span class="s2">for </span><span class="s1">i</span><span class="s3">, (</span><span class="s1">model_f</span><span class="s3">, </span><span class="s1">info_f</span><span class="s3">) </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">model_files</span><span class="s3">, </span><span class="s7">1</span><span class="s3">):</span>

                            <span class="s2">try</span><span class="s3">:</span>

                                <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">, </span><span class="s1">info_f</span><span class="s3">), </span><span class="s4">'r'</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf-8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">cf</span><span class="s3">:</span>

                                    <span class="s1">config </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">cf</span><span class="s3">)</span>

                                    <span class="s1">timestamp </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'timestamp'</span><span class="s3">, </span><span class="s4">'未知'</span><span class="s3">)</span>

                                    <span class="s1">val_loss </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'best_validation_loss'</span><span class="s3">, </span><span class="s4">'未知'</span><span class="s3">)</span>

                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">i</span><span class="s6">}</span><span class="s4">. </span><span class="s6">{</span><span class="s1">model_f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;   训练时间: </span><span class="s6">{</span><span class="s1">timestamp</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;   验证损失: </span><span class="s6">{</span><span class="s1">val_loss</span><span class="s6">:</span><span class="s4">.4f</span><span class="s6">}</span><span class="s4">&quot; </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">val_loss</span><span class="s3">, (</span>
                                    <span class="s1">int</span><span class="s3">, </span><span class="s1">float</span><span class="s3">)) </span><span class="s2">else </span><span class="s4">f&quot;   验证损失: </span><span class="s6">{</span><span class="s1">val_loss</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                            <span class="s2">except</span><span class="s3">:</span>

                                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">i</span><span class="s6">}</span><span class="s4">. </span><span class="s6">{</span><span class="s1">model_f</span><span class="s6">} </span><span class="s4">(无法读取配置信息)&quot;</span><span class="s3">)</span>

                        <span class="s1">model_choice </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请选择要使用的模型 [1-{}]: &quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">model_files</span><span class="s3">)))</span>

                        <span class="s2">try</span><span class="s3">:</span>

                            <span class="s1">model_index </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">model_choice</span><span class="s3">) - </span><span class="s7">1</span>

                            <span class="s2">if </span><span class="s7">0 </span><span class="s3">&lt;= </span><span class="s1">model_index </span><span class="s3">&lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">model_files</span><span class="s3">):</span>

                                <span class="s1">model_f</span><span class="s3">, </span><span class="s1">info_f </span><span class="s3">= </span><span class="s1">model_files</span><span class="s3">[</span><span class="s1">model_index</span><span class="s3">]</span>

                                <span class="s1">model_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">, </span><span class="s1">model_f</span><span class="s3">)</span>

                                <span class="s1">info_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">'models'</span><span class="s3">, </span><span class="s1">info_f</span><span class="s3">)</span>

                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">加载模型中...&quot;</span><span class="s3">)</span>

                                <span class="s0"># 加载模型配置</span>

                                <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">info_path</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf-8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>

                                    <span class="s1">model_info </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>

                                <span class="s0"># 创建模型实例</span>

                                <span class="s1">model </span><span class="s3">= </span><span class="s1">MicroneedleQualityModel</span><span class="s3">(</span>

                                    <span class="s1">len</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">),</span>

                                    <span class="s1">len</span><span class="s3">(</span><span class="s1">quality_score_components</span><span class="s3">),</span>

                                    <span class="s1">model_info</span><span class="s3">[</span><span class="s4">'hyperparameters'</span><span class="s3">][</span><span class="s4">'layer_sizes'</span><span class="s3">]</span>

                                <span class="s3">)</span>

                                <span class="s0"># 设置设备</span>

                                <span class="s1">device </span><span class="s3">= </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">device</span><span class="s3">(</span><span class="s4">&quot;cuda&quot; </span><span class="s2">if </span><span class="s1">torch</span><span class="s3">.</span><span class="s1">cuda</span><span class="s3">.</span><span class="s1">is_available</span><span class="s3">() </span><span class="s2">else </span><span class="s4">&quot;cpu&quot;</span><span class="s3">)</span>

                                <span class="s0"># 加载模型权重</span>

                                <span class="s1">model</span><span class="s3">.</span><span class="s1">load_state_dict</span><span class="s3">(</span><span class="s1">torch</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">model_path</span><span class="s3">, </span><span class="s1">map_location</span><span class="s3">=</span><span class="s1">device</span><span class="s3">))</span>

                                <span class="s1">model </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">to</span><span class="s3">(</span><span class="s1">device</span><span class="s3">)</span>

                                <span class="s1">model</span><span class="s3">.</span><span class="s1">eval</span><span class="s3">()</span>

                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;模型加载成功！&quot;</span><span class="s3">)</span>

                                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">模型信息:&quot;</span><span class="s3">)</span>

                                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;- 训练时间: </span><span class="s6">{</span><span class="s1">model_info</span><span class="s3">[</span><span class="s4">'timestamp'</span><span class="s3">]</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;- 最佳验证损失: </span><span class="s6">{</span><span class="s1">model_info</span><span class="s3">[</span><span class="s4">'best_validation_loss'</span><span class="s3">]</span><span class="s6">:</span><span class="s4">.4f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                                <span class="s0"># 显示参数范围参考</span>

                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 参数范围参考 ===&quot;</span><span class="s3">)</span>

                                <span class="s2">for </span><span class="s1">param </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">:</span>

                                    <span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">step </span><span class="s3">= </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">param</span><span class="s3">]</span>

                                    <span class="s1">unit </span><span class="s3">= </span><span class="s1">get_parameter_unit</span><span class="s3">(</span><span class="s1">param</span><span class="s3">)</span>

                                    <span class="s2">if </span><span class="s1">param </span><span class="s3">== </span><span class="s4">'print_mode'</span><span class="s3">:</span>

                                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">: 0-连续打印, 1-间歇打印, 2-往复打印&quot;</span><span class="s3">)</span>

                                    <span class="s2">else</span><span class="s3">:</span>

                                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">: </span><span class="s6">{</span><span class="s1">min_val</span><span class="s6">}</span><span class="s4">-</span><span class="s6">{</span><span class="s1">max_val</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">, 步长</span><span class="s6">{</span><span class="s1">step</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                                <span class="s0"># 运行预测循环</span>

                                <span class="s1">run_prediction_loop</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">device</span><span class="s3">)</span>


                            <span class="s2">else</span><span class="s3">:</span>

                                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">无效的选择！&quot;</span><span class="s3">)</span>

                                <span class="s2">continue</span>


                        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>

                            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请输入有效的数字！&quot;</span><span class="s3">)</span>

                            <span class="s2">continue</span>


                    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>

                        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;加载模型时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">加载模型时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                        <span class="s2">continue</span>

                <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;3&quot;</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">请先训练模型（选项1）后再使用此功能。&quot;</span><span class="s3">)</span>


                <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;4&quot;</span><span class="s3">:</span>

                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 生成合成数据 ===&quot;</span><span class="s3">)</span>

                    <span class="s2">try</span><span class="s3">:</span>

                        <span class="s1">num_samples </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;请输入要生成的样本数量 [1000]: &quot;</span><span class="s3">)</span>

                        <span class="s1">num_samples </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">) </span><span class="s2">if </span><span class="s1">num_samples</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">else </span><span class="s7">1000</span>

                        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">开始生成数据...&quot;</span><span class="s3">)</span>

                        <span class="s1">train_data</span><span class="s3">, </span><span class="s1">val_data </span><span class="s3">= </span><span class="s1">generate_synthetic_data</span><span class="s3">(</span><span class="s1">num_samples</span><span class="s3">)</span>

                        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">train_data</span><span class="s3">) &gt; </span><span class="s7">0</span><span class="s3">:</span>

                            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">数据生成成功！&quot;</span><span class="s3">)</span>

                        <span class="s2">else</span><span class="s3">:</span>

                            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">数据生成失败，请检查错误信息。&quot;</span><span class="s3">)</span>


                    <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>

                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">输入错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>

                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">生成数据时出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

                <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;5&quot;</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">=== 参数说明 ===&quot;</span><span class="s3">)</span>
                    <span class="s2">for </span><span class="s1">param </span><span class="s2">in </span><span class="s1">input_features</span><span class="s3">:</span>
                        <span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">step </span><span class="s3">= </span><span class="s1">PARAM_RANGES</span><span class="s3">[</span><span class="s1">param</span><span class="s3">]</span>
                        <span class="s1">unit </span><span class="s3">= </span><span class="s1">get_parameter_unit</span><span class="s3">(</span><span class="s1">param</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n{</span><span class="s1">param</span><span class="s6">}</span><span class="s4">:&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;范围: </span><span class="s6">{</span><span class="s1">min_val</span><span class="s6">}</span><span class="s4">-</span><span class="s6">{</span><span class="s1">max_val</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;步长: </span><span class="s6">{</span><span class="s1">step</span><span class="s6">}{</span><span class="s1">unit</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                    <span class="s1">input</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">按回车键继续...&quot;</span><span class="s3">)</span>

                <span class="s2">elif </span><span class="s1">choice </span><span class="s3">== </span><span class="s4">&quot;6&quot;</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">感谢使用！再见！&quot;</span><span class="s3">)</span>
                    <span class="s2">break</span>

                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">无效的选择，请重试。&quot;</span><span class="s3">)</span>

            <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">输入错误: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                <span class="s2">continue</span>
            <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;操作出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">操作出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
                <span class="s1">retry </span><span class="s3">= </span><span class="s1">safe_input</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">是否继续？(y/n) [y]: &quot;</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">retry</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s4">'n'</span><span class="s3">:</span>
                    <span class="s2">break</span>

    <span class="s2">except </span><span class="s1">KeyboardInterrupt</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n\n</span><span class="s4">程序被用户中断。&quot;</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;程序出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">\n</span><span class="s4">程序出错: </span><span class="s6">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s6">\n</span><span class="s4">正在退出程序...&quot;</span><span class="s3">)</span>
        <span class="s1">logging</span><span class="s3">.</span><span class="s1">shutdown</span><span class="s3">()</span></pre>
</body>
</html>